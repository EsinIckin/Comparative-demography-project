---
title: "Skua"
author: "Esin Ickin"
date: "6/23/2023"
output: html_document
---

## 0) Prepare session

```{r setup, include=FALSE}
knitr::opts_knit$set(root.dir = "~/SkuaPetrel")

```

```{r}
rm(list=ls())
set.seed(1234)
```

## 1) Demographic parameters and Age/Stage classes
```{r}
# Demographic parameters ----------------------------
# load MCMC posterior distributions
load("mcmc_env_cov_reg_coef.Rdata")

## Apparent survival for breeders petrels at year t-1
mu.phiB_p  <- -1.808  
delta_phiB_p_SAM  <- -0.053
delta_phiB_p_SST <- -0.157
delta_phiB_p_Chla  <- -0.567 
delta_phiB_p_DD  <- -0.345 # in table 3: -0.12 (but it's okay, see Maud's email: they standardized it afterwards for the paper, therefore it's different)
delta_phiB_p_PP <- 3.531 # in table 3: 0.27 (same as above)

mean(mat$delta_yB_p_SAM)
mean(mat$delta_yB_p_SST)
mean(mat$delta_yB_p_Chla)

delta_phiB_p_SAM <- mat$delta_yB_p_SAM
delta_phiB_p_SST <- mat$delta_yB_p_SST
delta_phiB_p_Chla <- mat$delta_yB_p_Chla

### Formula : 
# logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla * SAM_phi_p[t] + delta_phiB_p_SST * SST_phi_p[t] + delta_phiB_p_Chla * Chla_phi_p[t] + delta_phiB_p_DD * (Nadtot_p[t-1]/100) + delta_phiB_p_PP * (Nadtot_s[t-1]/100)        # Survie Breeder
# phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))

### Apparent survival from non breeders petrel at year t-1
mu.phiNB_p <- -1.044
delta_phiNB_p_SAM   <- 1.368 
delta_phiNB_p_SST   <- 0.115 
delta_phiNB_p_Chla  <- -1.417
delta_phiNB_p_DD    <- -2.906
delta_phiNB_p_PP  <- 9.470  

delta_phiNB_p_SAM <- mat$delta_yNB_p_SAM
delta_phiNB_p_SST <- mat$delta_yNB_p_SST
delta_phiNB_p_Chla <- mat$delta_yNB_p_Chla

### Formula :
# logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM * SAM_phi_p[t] + delta_phiNB_p_SST * SST_phi_p[t] + delta_phiNB_p_Chla * Chla_phi_p[t] + delta_phiNB_p_DD * (Nadtot_p[t-1]/100) + delta_phiNB_p_PP * (Nadtot_s[t-1]/100)        # Survie Breeder
# phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))

### Breeding probability for breeder petrels at year t-1

mu.bB_p  <- -3.649
delta_bB_p_SAM  <- -0.229
delta_bB_p_SST  <- 0.110 
delta_bB_p_Chla <- 0.361  
delta_bB_p_DD   <- 1.927

delta_bB_p_SAM <- mat$delta_bB_p_SAM
delta_bB_p_SST <- mat$delta_bB_p_SST
delta_bB_p_Chla <- mat$delta_bB_p_Chla

### Formula :

# logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM  * SAM_b_p[t] + delta_bB_p_SST * SST_b_p[t] + delta_bB_p_Chla * Chla_b_p[t] + delta_bB_p_DD * (N_alive_p[t]/100)
# bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))

### Breeding probability for non breeder petrels at year t-1

mu.bNB_p <- -2.489
delta_bNB_p_SAM  <- 0.108  
delta_bNB_p_SST  <- 0.312  
delta_bNB_p_Chla <- 0.783  
delta_bNB_p_DD   <- 1.002 

delta_bNB_p_SAM <- mat$delta_bNB_p_SAM
delta_bNB_p_SST <- mat$delta_bNB_p_SST
delta_bNB_p_Chla <- mat$delta_bNB_p_Chla

### Formula :
# logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM  * SAM_b_p[t] + delta_bNB_p_SST * SST_b_p[t] + delta_bNB_p_Chla * Chla_b_p[t] + delta_bNB_p_DD * (N_alive_p[t]/100)
# bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))

### Hatching success for breeder petrels at year t-1 

mu.wB_p  <- -4.686
delta_wB_p_SAM  <- 0.292 
delta_wB_p_SST  <- 0.128 
delta_wB_p_Chla <- -0.229
delta_wB_p_DD   <- 0.420 
delta_wB_p_PP <- 3.778  

delta_wB_p_SAM <- mat$delta_wB_p_SAM
delta_wB_p_SST <- mat$delta_wB_p_SST
delta_wB_p_Chla <- mat$delta_wB_p_Chla

# logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM * SAM_w_p[t] + delta_wB_p_SST * SST_w_p[t] + delta_wB_p_Chla * Chla_w_p[t] + delta_wB_p_DD * (N_alive_p[t]/100) + delta_wB_p_PP * (N_alive_s[t]/100)
# wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))

### Hatching success for non-breeder petrels at year t-1 

mu.wNB_p <- -1.495
delta_wNB_p_SAM  <- 0.642 
delta_wNB_p_SST  <- 0.007 
delta_wNB_p_Chla <- -0.255
delta_wNB_p_DD   <- -1.157
delta_wNB_p_PP  <- 3.712  

delta_wNB_p_SAM <- mat$delta_wNB_p_SAM
delta_wNB_p_SST <- mat$delta_wNB_p_SST
delta_wNB_p_Chla <- mat$delta_wNB_p_Chla

### Formula :
# logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM * SAM_w_p[t] + delta_wNB_p_SST * SST_w_p[t] + delta_wNB_p_Chla  * Chla_w_p[t] + delta_wNB_p_DD * (N_alive_p[t]/100) + delta_wNB_p_PP * (N_alive_s[t]/100)
# wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))

### Breeding success for breeder petrels at year t-1

mu.gB_p  <- 2.784
delta_gB_p_SAM  <- 0.527 
delta_gB_p_SST  <- -0.338
delta_gB_p_Chla <- -0.185
delta_gB_p_DD   <- -0.37 
delta_gB_p_PP <- -0.615 

delta_gB_p_SAM <- mat$delta_gB_p_SAM
delta_gB_p_SST <- mat$delta_gB_p_SST
delta_gB_p_Chla <- mat$delta_gB_p_Chla

### Formula :
# logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM * SAM_g_p[t] + delta_gB_p_SST  * SST_g_p[t] + delta_gB_p_Chla * Chla_g_p[t] + delta_gB_p_DD  * (N_alive_p[t]/100) + delta_gB_p_PP * (N_alive_s[t]/100) 
# gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))

## Breeding sucess for non breeder petrels at year t-1

mu.gNB_p <- -1.401
delta_gNB_p_SAM  <- 0.417  
delta_gNB_p_SST  <- -0.506 
delta_gNB_p_Chla <- - 0.847
delta_gNB_p_DD   <- -2.955 
delta_gNB_p_PP  <- 7.868  

delta_gNB_p_SAM <- mat$delta_gNB_p_SAM
delta_gNB_p_SST <- mat$delta_gNB_p_SST
delta_gNB_p_Chla <- mat$delta_gNB_p_Chla

### Formula
# logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM * SAM_g_p[t] + delta_gNB_p_SST * SST_g_p[t] + delta_gNB_p_Chla * Chla_g_p[t] + delta_gNB_p_DD * (N_alive_p[t]/100) + delta_gNB_p_PP * (N_alive_s[t]/100)
# gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))


## Apparent survival for breeder skuas at year t-1
mu.phiB_s  <- 3.785  
delta_phiB_s_SAM  <- -0.337
delta_phiB_s_DD   <- -1.184

delta_phiB_s_SAM <- mat$delta_yB_s_SAM

### Formula :
# logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM * SAM_phi_s[t] + delta_phiB_s_DD * (Nadtot_s[t-1]/100)     # Survie Breeder
# phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))

## Apparent survival for non breeder skuas at year t-1
mu.phiNB_s <- 3.34     
delta_phiNB_s_SAM  <- 0.416  
delta_phiNB_s_DD  <- -1.546

delta_phiNB_s_SAM <- mat$delta_yB_s_SAM

### Formula :
# logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM * SAM_phi_s[t] + delta_phiNB_s_DD * (Nadtot_s[t-1]/100)  
# phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1]))  

## Breeding probability for breeder skuas at year t-1
mu.bB_s  <- -0.719 
delta_bB_s_SAM  <- 0.283
delta_bB_s_DD   <- 2.838

delta_bB_s_SAM <- mat$delta_bB_s_SAM

### Formula :
# logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM * SAM_b_s[t] + delta_bB_s_DD * (N_alive_s[t]/100)     
# bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))

## Breeding probability for non breeder skuas at year t-1
mu.bNB_s <- -2.047 
delta_bNB_s_SAM  <- 0.809
delta_bNB_s_DD   <- 1.190

delta_bNB_s_SAM <- mat$delta_bNB_s_SAM

### Formula :
# logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM * SAM_b_s[t] + delta_bNB_s_DD  * (N_alive_s[t]/100)    
# bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))

## Breeding success with at least one chick for breeder skuas at year t-1
mu.gB_s  <- 3.216  
delta_gB_s_SAM <- -0.097
delta_gB_s_DD  <- -5.213
delta_gB_s_PP   <- 1.963

delta_gB_s_SAM <- mat$delta_gB_s_SAM

### Formula :
# logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM * SAM_g_s[t] + delta_gB_s_DD * (N_alive_s[t]/100) + delta_gB_s_PP * (N_alive_p[t]/100)   
# gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))


## Breeding success with at least one chick for non breeder skuas at year t-1

mu.gNB_s <- 2.571  
delta_gNB_s_SAM <- -0.238
delta_gNB_s_DD  <- -3.335
delta_gNB_s_PP  <- 0.825

delta_gNB_s_SAM <- mat$delta_gNB_s_SAM

### Formula :
# logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM * SAM_g_s[t] + delta_gNB_s_DD * (N_alive_s[t]/100) + delta_gNB_s_PP * (N_alive_p[t]/100) 
# gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))

## Breeding success with two chicks for breeder skuas at year t-1
mu.dB_s  <- -1.543
delta_dB_s_SAM <- -0.292
delta_dB_s_DD  <- -7.012
delta_dB_s_PP   <- 3.770

delta_dB_s_SAM <- mat$delta_dB_s_SAM

### Formula :
# logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM * SAM_d_s[t] + delta_dB_s_DD * (N_alive_s[t]/100) + delta_dB_s_PP * (N_alive_p[t]/100)
# dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))

## Breeding success with two chicks for non breeder skuas at year t-1
mu.dNB_s <- -0.167 
delta_dNB_s_SAM <- -0.529
delta_dNB_s_DD  <- -5.341
delta_dNB_s_PP  <- 2.020

delta_dNB_s_SAM <- mat$delta_dNB_s_SAM

### Formula :
# logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM * SAM_d_s[t] + delta_dNB_s_DD * (N_alive_s[t]/100) + delta_dNB_s_PP * (N_alive_p[t]/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
# dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))


## Apparent juvenile survival for skuas
phi1_s <- 0.312
phi2_s <- 0.379
phi3_s <- 0.452
phi4_s <- 0.522

## First breeding probability for skuas
meanPR_s <- 0.505

## Apparent juvenile survival for petrels
phi1_p <- 0.237
phi2_p <- 0.277
phi3_p <- 0.324
phi4_p <- 0.373

## First breeding probability for petrels
meanPR_p <- 0.495

## Fecundity for successful skua breeder with one chick
fecSB1_s <- 1
## Fecundity for successful skua breeder with two chicks
fecSB2_s <- 2
## Fecundity for successful petrel breeder with one chicks
fecSB1_p <- 1

### Create empty vectors for the differents demographic parameters that depend on covariates :

logit_phiB_s  <- NULL
logit_phiNB_s <- NULL
logit_bB_s  <- NULL
logit_bNB_s <- NULL
logit_gB_s  <- NULL
logit_gNB_s <- NULL
logit_dB_s  <- NULL
logit_dNB_s <- NULL

phiB_s  <- NULL
phiNB_s <- NULL
bB_s  <- NULL
bNB_s <- NULL
gB_s  <- NULL
gNB_s <- NULL
dB_s  <- NULL
dNB_s <- NULL

logit_phiB_p  <- NULL
logit_phiNB_p <- NULL
logit_bB_p  <- NULL
logit_bNB_p <- NULL
logit_wB_p  <- NULL
logit_wNB_p <- NULL
logit_gB_p  <- NULL
logit_gNB_p <- NULL

phiB_p  <- NULL
phiNB_p <- NULL
bB_p  <- NULL
bNB_p <- NULL
wB_p  <- NULL
wNB_p <- NULL
gB_p  <- NULL
gNB_p <- NULL


# Age/Stage Classes ------------------------------------------------------------

# Create empty vector for the different age/stage classes
Nadtot_s  <- NULL
NB_s      <- NULL
B_s       <- NULL
SB1_s     <- NULL
SB2_s     <- NULL
F1_s      <- NULL
J2_s      <- NULL
J3_s      <- NULL
J4_NB_s   <- NULL

Nadtot_p  <- NULL
NB_p      <- NULL
B_p       <- NULL
SB_p      <- NULL
F1_p      <- NULL
J2_p      <- NULL
J3_p      <- NULL
J4_NB_p   <- NULL

meanF1_s  <- NULL
PR_s      <- NULL
J4_J3_s   <- NULL
J4_alive_s<- NULL
J4_s      <- NULL
J4_B_s    <- NULL
NB_alive_s<- NULL
B_alive_s <- NULL
N_alive_s <- NULL
NB_B_i_s  <- NULL
NB_NB_s   <- NULL
B_B_s     <- NULL
B_NB_s    <- NULL
NB_B_s    <- NULL
NB_SB_s   <- NULL
NB_FB_s   <- NULL
B_SB_s    <- NULL
B_FB_s    <- NULL
FB_s      <- NULL
NB_SB2_s  <- NULL
NB_SB1_s  <- NULL
B_SB2_s   <- NULL
B_SB1_s   <- NULL

meanF1_p  <- NULL
PR_p      <- NULL
J4_J3_p   <- NULL
J4_alive_p<- NULL
J4_p      <- NULL
J4_B_p    <- NULL
NB_alive_p<- NULL
B_alive_p <- NULL
N_alive_p <- NULL
NB_B_i_p  <- NULL
NB_NB_p   <- NULL
B_B_p     <- NULL
B_NB_p    <- NULL
NB_B_p    <- NULL
NB_SH_p   <- NULL
NB_FBE_p  <- NULL
B_SH_p    <- NULL
B_FBE_p   <- NULL
FBE_p     <- NULL
NB_SB_p   <- NULL
NB_FBC_p  <- NULL
B_FBC_p   <- NULL
B_SB_p    <- NULL
FBC_p     <- NULL


### First year 

Nadtot_s[1] <- 104 # initial pop size?
NB_s[1]     <- 10
B_s[1]      <- 94
SB1_s[1]    <- 40
SB2_s[1]    <- 40
F1_s[1]     <- 60 
J2_s[1]     <- 20 
J3_s[1]     <- 5
J4_NB_s[1]  <- 3

Nadtot_p[1] <- 230 
NB_p[1]     <- 10
B_p[1]      <- 220
SB_p[1]    <- 100
F1_p[1]     <- 50
J2_p[1]     <- 30
J3_p[1]     <- 20
J4_NB_p[1]  <- 3

### Immigrants 

nb_im_s <- c(0, 4, 0, 8, 6, 3, 7, 14, 10, 18, 12, 4, 4, 5, 10, 3, 8, 7, 
             0, 3, 12, 3)
nb_im_p <- c(0, 27, 32, 39, 19, 54, 62, 78, 56, 6, 31, 31, 51, 21, 22, 78, 
             51, 17, 11, 17, 16, 36)
```

## 2) Covariates

As long as the different SAM_phi_s, SAM_b_s... values remain within similar value ranges (to be verified),  in my view, averaging them should not be a source of problems and above all it will simplify the analyses. Moreover, the value ranges should probably also be the same for petrels and skuas, so it would also be possible to average the covariates for both species at the same time (so no longer have SAM_p and SAM_s but only one covariate SAM).

```{r}
# Environmental covariates (standardized) ---------------------------------------

# SAM for survival of skuas
SAM_phi_s <- c(-0.653646778522956, 0.349291223008586, 0.691976658236716, 0.089137358568383, 
               -0.329800071409461, -0.037351244487026, -0.872534857569196, 0.0110911992363221, 
               0.421057806302436, -0.0185125163723906, 0.0837548648213444, -0.957757675230642, 
               0.03351825651565, -0.534334833796931, 0.535884339572594, -0.376448350550463, 
               0.549340573940191, -0.406052066159176, -0.121676979857299, 0.755669500910007, 
               0.634563391601637, 0.152830201241674)

# SAM for breeding probability of skuas
SAM_b_s <- c(-0.70859995677669, -0.299839536752228, 0.80257492937435, 0.73388516182203, 
             -0.562211927566828, 0.498538253323097, -0.949577174091386, 0.171980342008789, 
             0.173106403771942, -0.00481135480619829, -0.0385932077007819, 
             -0.748012118487038, 0.399444818165652, -0.457488183593619, 1.16741894063585, 
             -0.657927177434815, 0.407327250507722, -0.687204783276787, 0.193375515508692, 
             0.629161417848821, -0.338125636699423, 0.275578024218846)

# SAM for breeding success of skuas
SAM_g_s <- c(0.0427717529953161, -0.620239581366561, 0.527321635204322, 
             1.20006723059272, -0.707847930605243, 0.753372807931292, -0.980407239347809, 
             -0.498020526255807, -0.350925026299502, -0.715419022514759, 0.275312433073299, 
             0.27098609483929, 0.442958039641147, -0.462328235825233, 0.600869385182475, 
             0.113074749297962, -0.0513261035943794, -0.26331667706082, 0.786901929244862, 
             0.312086308062375, -1.17401087531971, 0.498118852124762)

# SAM for breeding success of skuas (2 chicks)
SAM_d_s <- c(0.0427717529953161, -0.620239581366561, 0.527321635204322, 
             1.20006723059272, -0.707847930605243, 0.753372807931292, -0.980407239347809, 
             -0.498020526255807, -0.350925026299502, -0.715419022514759, 0.275312433073299, 
             0.27098609483929, 0.442958039641147, -0.462328235825233, 0.600869385182475, 
             0.113074749297962, -0.0513261035943794, -0.26331667706082, 0.786901929244862, 
             0.312086308062375, -1.17401087531971, 0.498118852124762)

# SAM for survival of petrel
SAM_phi_p <- c(-0.709471691150386, 0.318539011509285, 0.598974284073063, 0.0902601643010346, 
               -0.129703890459233, -0.262740569626956, -0.550734744416173, -0.0919093793320395, 
               0.075898250072701, 0.0774100305177888, -0.0964447206673028, -0.655803485349771, 
               0.0834571522981398, -0.406359711910292, 0.264114915486126, -0.278614264300377, 
               0.320050791954373, -0.154648267803181, -0.102491842447654, 0.981454736680265, 
               0.609556747188678, 0.0192064833819103)

# SAM for breeding probability of petrel
SAM_b_p <- c(-0.589955010647014, -0.0635284315949512, 0.579675874500351, 
             0.915180137910292, -0.597369469506902, 0.492555982896664, -1.26467076689684, 
             0.268268602385046, 0.216367390365829, 0.142222801766947, -0.208110379362771, 
             -0.562150789922433, 0.603772865794987, -0.326741721120983, 0.757622887137668, 
             -0.360106785990479, 0.41655777958281, -1.3666195762203, 0.307194511399459, 
             0.574115030355435, 0.051395680733316, 0.0143233864338749)

# SAM for hatching probability of petrel
SAM_w_p <- c(-0.122441312349111, -1.24556281410866, 0.717225715156836, 1.27522100095166, 
             -0.589517238477684, 0.697615657189605, -0.997762990704566, -0.332803752361216, 
             -0.701829388653638, -0.598430901190061, 0.378506532086496, 0.146751301564685, 
             0.553214321249092, 0.0380046164736816, 1.10051321178906, 0.260846184283115, 
             -0.36667567066825, -0.124224044891586, 0.530038798196911, 0.0665283371532891, 
             -1.19029810529192, 0.505080542602255)

# SAM for breeding success of petrel
SAM_g_p <- c(0.0934672756197052, -0.108376166209351, 0.866149201371562, 
             1.45275670418726, -0.858981465511155, 0.402540045920448, -0.420602740288673, 
             -0.0736843246449823, -0.647676612346362, -1.35728246252664, -0.231374513573933, 
             1.02699319407909, 0.292156913670183, -0.445833170517305, -0.433217955402989, 
             1.38968062861568, -0.723367903032258, -0.4616021894102, 0.534999804620767, 
             0.550768823513661, -1.49604982878412, 0.648536740649611)

# SST for survival of petrel
SST_phi_p <- c(0.494072208346483, 1.26864459409835, 0.0420055414802291, -0.442255894194649, 
               -0.975289690477478, 0.622425745773877, 0.793488470671052, 0.566707435410548, 
               -0.396348416269095, -0.116711432779343, -0.57319159174234, -0.47738903412952, 
               -0.956184792195757, -0.298338443411363, 0.124981514287261, 0.333969844702856, 
               -0.0679578245579948, 0.0873562932537208, -0.686415594311321, 
               -0.727550124471673, 0.0401660343134674, 1.34381515620269)

# SST for breeding probability of petrel 
SST_b_p <- c(0.646673005788706, 0.433589485150274, -0.253730166510335, -1.01688393317054, 
             -0.782558227424509, 0.733944581592205, 1.56278043702511, 0.0650925090237517, 
             0.0693819695534198, -0.804737649616686, -2.08181887080295, -0.7865010205216, 
             -0.201149888086663, 0.601150708045111, -0.471226229230409, 1.44632395324531, 
             0.385120177560282, -0.0289392638046612, -1.22222498091934, 0.346252138817837, 
             0.769602915764416, 0.58985834852127)

# SST for hatching success of petrel
SST_w_p <- c(1.31043054118228, 0.945829188453443, -0.122758042464106, -0.274547121280507, 
             -0.595016670387565, 1.42385462480458, 0.698032561011594, -0.681873866936094, 
             -0.340896767536892, -0.904118992637916, -1.38235551468409, -1.36833931408074, 
             -0.303510377267568, 0.0962965640086766, -0.601271848698926, 1.39466150273184, 
             0.213420974585527, 0.227833091463511, -1.36499739556542, 0.197769680956571, 
             0.608507847251656, 0.823049335090138)

# SST for breeding success of petrel
SST_g_p <- c(2.12367961416112, 1.06102692467509, 0.364664215877409, -0.633383348042281, 
             -0.463084989530878, 1.54851280802907, 0.235816215970718, -1.28670507886572, 
             -0.610370026454485, -0.880349782899911, -1.1444933846835, -1.3071276781976, 
             -0.208098421984393, -0.590617941415038, -0.343694914437196, 0.895707189869463, 
             0.545953748066898, 0.618021865010254, -1.32796560177984, -0.317542993774488, 
             0.80016827264, 0.919883307765301)

# Chla for survival of petrel
Chla_phi_p <-c(NaN, -0.458869746615771, -0.782741887054497, -0.583503437030834, 
               -0.377505252484353, -0.743481097392018, -0.746569019825685, -0.098891128961761, 
               -0.0791891350923812, 0.0628874684731653, -0.0869401460784413, 
               -0.137582733940792, -0.434201047901044, 0.133267838851519, 0.385832525707168, 
               0.835059659495155, 0.482557981955533, 0.551736841833326, 1.01427575950848, 
               0.649582119013642, 0.411721933262594, 0.520735574260695)

# Chla for breeding probability of petrel
Chla_b_p <-c(NaN, 0.105657085180641, -0.897699842834123, -0.650160244739036, 
             -0.765273673120492, -0.793254205773427, -0.617708422134721, 0.0354149023580064, 
             0.135053078052794, -0.0124185377342928, 0.082284212084582, -0.24446954968627, 
             -0.355785020980162, -0.264471698237342, -0.000557773829125761, 
             0.0255669380718607, 0.0698810958122885, 0.70432521989856, 1.05501453038185, 
             0.904155363321496, 0.70342619657025, 0.816239375730203)

# Chla for hatching success of petrel
Chla_w_p <- c(NaN, -0.655211822324861, -0.67552649751913, -0.220760385131503, 
              -1.10143099619223, -0.435497360738455, -0.719333821114563, 0.529177973223898, 
              0.545229533217972, -0.026640762415332, 0.801992100970641, -0.160449932029789, 
              -0.722097948524417, 0.627640604041084, 0.145836515441017, -0.23628198724011, 
              0.0945588024876029, 0.0516872016841462, 0.952552181935311, 0.219168506142157, 
              0.751704156143962, 0.551201331921027)

# Chla for breeding success of petrel
Chla_g_p <-c(NaN, -0.70641811640458, -0.482874180683779, 0.184539775981027, 
             -1.02577667997288, -1.0017388300069, -0.648862365374702, 0.863637705858761, 
             -0.0949539373663149, 0.350752401918377, 0.126819758373404, -0.760503507709628, 
             -0.862041300518189, 1.02646307879273, 0.63707020645674, 0.156058270380365, 
             0.0302450020484413, -0.00216262964224323, 1.34155316541966, 0.536104910859089, 
             0.0489244486397669, 0.283162822950874)

# DENSITY
dens_s=read.table("Data/Counts/Data_counts_skua.txt", quote="\"", comment.char="")
colnames(dens_s)="dens_s"
dens_p=read.table("Data/Counts/Data_counts_petrel.txt", quote="\"", comment.char="")
colnames(dens_p)="dens_p"

# Time series
cov=data.frame(year=1996:2017,SAM_b_s,SAM_d_s,SAM_g_s,SAM_phi_s,SAM_b_p,SAM_g_p,SAM_phi_p,SAM_w_p,SST_phi_p,SST_b_p,SST_w_p,SST_g_p,Chla_phi_p,Chla_b_p,Chla_w_p,Chla_g_p,dens_s,dens_p)

```


### 2.1 Mean SAM, SST, Chla
```{r}
# since there are 4 different SAM values for both species, what if I just take the average (see plots in 2)
cov=na.omit(cov)
# SKUA
cov$SAM_s=rowMeans(cov[, c("SAM_phi_s", "SAM_g_s", "SAM_b_s", "SAM_d_s")])
# PETREL
cov$SAM_p=rowMeans(cov[, c("SAM_phi_p", "SAM_b_p", "SAM_g_p", "SAM_w_p")])


# dens_s
max_dens_s = max(cov$dens_s)
min_dens_s = min(cov$dens_s)
mean_dens_s = mean(cov$dens_s)
sd_dens_s = sd(cov$dens_s)

# SST
cov$SST=rowMeans(cov[, c("SST_phi_p", "SST_b_p", "SST_w_p", "SST_g_p")])
max_SST=max(cov$SST)
min_SST=min(cov$SST)
mean_SST=mean(cov$SST)
sd_SST=sd(cov$SST)

# Chla
cov$Chla=rowMeans(cov[, c("Chla_phi_p", "Chla_b_p", "Chla_w_p", "Chla_g_p")])
max_Chla=max(cov$Chla)
min_Chla=min(cov$Chla)
mean_Chla=mean(cov$Chla)
sd_Chla=sd(cov$Chla)

# dens_p
max_dens_p = max(cov$dens_p)
min_dens_p = min(cov$dens_p)
mean_dens_p = mean(cov$dens_p)
sd_dens_p = sd(cov$dens_p)

# SAM for both species
cov$SAM=rowMeans(cov[,c("SAM_s","SAM_p")])
plot(cov$SAM, type="l")
lines(cov$SAM_p, col ="brown")
lines(cov$SAM_s, col = "blue")

max_SAM=max(cov$SAM)
min_SAM=min(cov$SAM)
mean_SAM=mean(cov$SAM)
sd_SAM=sd(cov$SAM)

# Covariation

# SAM
dens_s_when_SAM_max=cov$dens_s[which(cov$SAM==max(cov$SAM))][1]
dens_s_when_SAM_min=cov$dens_s[which(cov$SAM==min(cov$SAM))][1]
dens_p_when_SAM_max=cov$dens_p[which(cov$SAM==max(cov$SAM))][1]
dens_p_when_SAM_min=cov$dens_p[which(cov$SAM==min(cov$SAM))][1]
SST_when_SAM_max=cov$SST[which(cov$SAM==max(cov$SAM))][1]
SST_when_SAM_min=cov$SST[which(cov$SAM==min(cov$SAM))][1]
Chla_when_SAM_max=cov$Chla[which(cov$SAM==max(cov$SAM))][1]
Chla_when_SAM_min=cov$Chla[which(cov$SAM==min(cov$SAM))][1]

# skua density
SAM_when_dens_s_max=cov$SAM[which(cov$dens_s==max(cov$dens_s))][1]
SAM_when_dens_s_min=cov$SAM[which(cov$dens_s==min(cov$dens_s))][1]
dens_p_when_dens_s_max=cov$dens_p[which(cov$dens_s==max(cov$dens_s))][1]
dens_p_when_dens_s_min=cov$dens_p[which(cov$dens_s==min(cov$dens_s))][1]
SST_when_dens_s_max=cov$SST[which(cov$dens_s==max(cov$dens_s))][1]
SST_when_dens_s_min=cov$SST[which(cov$dens_s==min(cov$dens_s))][1]
Chla_when_dens_s_max=cov$Chla[which(cov$dens_s==max(cov$dens_s))][1]
Chla_when_dens_s_min=cov$Chla[which(cov$dens_s==min(cov$dens_s))][1]

# petrel density
SAM_when_dens_p_max=cov$SAM[which(cov$dens_p==max(cov$dens_p))][1]
SAM_when_dens_p_min=cov$SAM[which(cov$dens_p==min(cov$dens_p))][1]
dens_s_when_dens_p_max=cov$dens_s[which(cov$dens_p==max(cov$dens_p))][1]
dens_s_when_dens_p_min=cov$dens_s[which(cov$dens_p==min(cov$dens_p))][1]
SST_when_dens_p_max=cov$SST[which(cov$dens_p==max(cov$dens_p))][1]
SST_when_dens_p_min=cov$SST[which(cov$dens_p==min(cov$dens_p))][1]
Chla_when_dens_p_max=cov$Chla[which(cov$dens_p==max(cov$dens_p))][1]
Chla_when_dens_p_min=cov$Chla[which(cov$dens_p==min(cov$dens_p))][1]

# Chla
SAM_when_Chla_max=cov$SAM[which(cov$Chla==max(cov$Chla))][1]
SAM_when_Chla_min=cov$SAM[which(cov$Chla==min(cov$Chla))][1]
SST_when_Chla_max=cov$SST[which(cov$Chla==max(cov$Chla))][1]
SST_when_Chla_min=cov$SST[which(cov$Chla==min(cov$Chla))][1]
dens_s_when_Chla_max=cov$dens_s[which(cov$Chla==max(cov$Chla))][1]
dens_s_when_Chla_min=cov$dens_s[which(cov$Chla==min(cov$Chla))][1]
dens_p_when_Chla_max=cov$dens_p[which(cov$Chla==max(cov$Chla))][1]
dens_p_when_Chla_min=cov$dens_p[which(cov$Chla==min(cov$Chla))][1]

# SST
SAM_when_SST_max=cov$SAM[which(cov$SST==max(cov$SST))][1]
SAM_when_SST_min=cov$SAM[which(cov$SST==min(cov$SST))][1]
Chla_when_SST_max=cov$Chla[which(cov$SST==max(cov$SST))][1]
Chla_when_SST_min=cov$Chla[which(cov$SST==min(cov$SST))][1]
dens_s_when_SST_max=cov$dens_s[which(cov$SST==max(cov$SST))][1]
dens_s_when_SST_min=cov$dens_s[which(cov$SST==min(cov$SST))][1]
dens_p_when_SST_max=cov$dens_p[which(cov$SST==max(cov$SST))][1]
dens_p_when_SST_min=cov$dens_p[which(cov$SST==min(cov$SST))][1]
```


## 3) Pop model with mean covariates (SAM for both species the same)
```{r}
# MODEL ----------------

# empty vector for lambda
lambda_s=NULL # to store lambdas of one run of the model (10 years)
lambda_p=NULL # to store lambdas of one run of the model (10 years)
lambda_mean_s=NULL # to store the mean of the 10-yrs of each simulation (500 simulations)
lambda_mean_p=NULL # to store the mean of the 10-yrs of each simulation (500 simulations)

# empty vector for final lambdas (to get the uncertainties)
s_lambda=NULL # to store all the means (lambda_mean_s) 100 times
p_lambda=NULL # to store all the means (lambda_mean_p) 100 times

# Number of years 
# N <- 10 originally only 10 years
N <- 20 # try 20 years
# when doing more than 20 yrs of projection it creates NAs, so we will stick to 20 years
for(u in 1:10){ # sample parameter from distribution only 10 times
    for(t in 2:N) { # project pop for 20 years
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * mean_SAM + delta_phiNB_p_SST[u] * mean_SST + delta_phiNB_p_Chla[u] * mean_Chla + delta_phiNB_p_DD * (mean_dens_p/100) + delta_phiNB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * mean_SAM + delta_phiB_p_SST[u] * mean_SST + delta_phiB_p_Chla[u] * mean_Chla + delta_phiB_p_DD * (mean_dens_p/100) + delta_phiB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * mean_SAM + delta_bNB_p_SST[u] * mean_SST + delta_bNB_p_Chla[u] * mean_Chla + delta_bNB_p_DD * (mean_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * mean_SAM + delta_wNB_p_SST[u] * mean_SST + delta_wNB_p_Chla[u]  * mean_Chla + delta_wNB_p_DD * (mean_dens_p/100) + delta_wNB_p_PP * (mean_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * mean_SAM + delta_gNB_p_SST[u] * mean_SST + delta_gNB_p_Chla[u] * mean_Chla + delta_gNB_p_DD * (mean_dens_p/100) + delta_gNB_p_PP * (mean_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * mean_SAM + delta_bB_p_SST[u] * mean_SST + delta_bB_p_Chla[u] * mean_Chla + delta_bB_p_DD * (mean_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * mean_SAM + delta_wB_p_SST[u] * mean_SST + delta_wB_p_Chla[u] * mean_Chla + delta_wB_p_DD * (mean_dens_p/100) + delta_wB_p_PP * (mean_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * mean_SAM + delta_gB_p_SST[u]  * mean_SST + delta_gB_p_Chla[u] * mean_Chla + delta_gB_p_DD  * (mean_dens_p/100) + delta_gB_p_PP * (mean_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  lambda_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  lambda_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
    }
  # treat the first 10 years as transient dynamics
  longterm_s <- lambda_s[11:20]
  longterm_p <- lambda_p[11:20]
  
}


plot(lambda_s, type="l")
plot(lambda_p, type="l")
plot(longterm_s,type="l")
```



## 4) Scaled sensitivities to SAM

Here, we calculate scaled sensitivities, according to Morris et al. 2020 (DOI: https://doi.org/10.1073/pnas.1918363117)

Note that this is a step that Esin will implement in her MS thesis. With the information given in 1-3, we should be able to run these analyses.

### 4.1 Without covariation
```{r}

# MODEL ----------------

# empty vector for lambdas
# to calculate lambdas for 10 years: l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
l_max_s=NULL 
l_max_p=NULL
l_min_s=NULL
l_min_p=NULL

# without simulations (to get uncertainties), mean_lambda_max_s is going to be only 1 value
mean_lambda_max_s=NULL
mean_lambda_max_p=NULL
mean_lambda_min_s=NULL
mean_lambda_min_p=NULL

# to store 10 deltas (to get uncertainties)
s.delta.SAM=NULL
p.delta.SAM=NULL

# 20 years projection
N <- 20 

for(u in 1:50){ # 50 resampling for uncertainties
  for(t in 2:N) { # 20 years projections
    
    # MAX SAM
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * max_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * max_SAM + delta_phiNB_p_SST[u] * mean_SST + delta_phiNB_p_Chla[u] * mean_Chla + delta_phiNB_p_DD * (mean_dens_p/100) + delta_phiNB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * max_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * max_SAM + delta_phiB_p_SST[u] * mean_SST + delta_phiB_p_Chla[u] * mean_Chla + delta_phiB_p_DD * (mean_dens_p/100) + delta_phiB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * max_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * max_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * max_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * max_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * max_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * max_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * max_SAM + delta_bNB_p_SST[u] * mean_SST + delta_bNB_p_Chla[u] * mean_Chla + delta_bNB_p_DD * (mean_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * max_SAM + delta_wNB_p_SST[u] * mean_SST + delta_wNB_p_Chla[u]  * mean_Chla + delta_wNB_p_DD * (mean_dens_p/100) + delta_wNB_p_PP * (mean_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * max_SAM + delta_gNB_p_SST[u] * mean_SST + delta_gNB_p_Chla[u] * mean_Chla + delta_gNB_p_DD * (mean_dens_p/100) + delta_gNB_p_PP * (mean_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * max_SAM + delta_bB_p_SST[u] * mean_SST + delta_bB_p_Chla[u] * mean_Chla + delta_bB_p_DD * (mean_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * max_SAM + delta_wB_p_SST[u] * mean_SST + delta_wB_p_Chla[u] * mean_Chla + delta_wB_p_DD * (mean_dens_p/100) + delta_wB_p_PP * (mean_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * max_SAM + delta_gB_p_SST[u]  * mean_SST + delta_gB_p_Chla[u] * mean_Chla + delta_gB_p_DD  * (mean_dens_p/100) + delta_gB_p_PP * (mean_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_max_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
  }
    
  for(t in 2:N) { # MIN SAM
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * min_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * min_SAM + delta_phiNB_p_SST[u] * mean_SST + delta_phiNB_p_Chla[u] * mean_Chla + delta_phiNB_p_DD * (mean_dens_p/100) + delta_phiNB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * min_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * min_SAM + delta_phiB_p_SST[u] * mean_SST + delta_phiB_p_Chla[u] * mean_Chla + delta_phiB_p_DD * (mean_dens_p/100) + delta_phiB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * min_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * min_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * min_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * min_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * min_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * min_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * min_SAM + delta_bNB_p_SST[u] * mean_SST + delta_bNB_p_Chla[u] * mean_Chla + delta_bNB_p_DD * (mean_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * min_SAM + delta_wNB_p_SST[u] * mean_SST + delta_wNB_p_Chla[u]  * mean_Chla + delta_wNB_p_DD * (mean_dens_p/100) + delta_wNB_p_PP * (mean_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * min_SAM + delta_gNB_p_SST[u] * mean_SST + delta_gNB_p_Chla[u] * mean_Chla + delta_gNB_p_DD * (mean_dens_p/100) + delta_gNB_p_PP * (mean_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * min_SAM + delta_bB_p_SST[u] * mean_SST + delta_bB_p_Chla[u] * mean_Chla + delta_bB_p_DD * (mean_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * min_SAM + delta_wB_p_SST[u] * mean_SST + delta_wB_p_Chla[u] * mean_Chla + delta_wB_p_DD * (mean_dens_p/100) + delta_wB_p_PP * (mean_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * min_SAM + delta_gB_p_SST[u]  * mean_SST + delta_gB_p_Chla[u] * mean_Chla + delta_gB_p_DD  * (mean_dens_p/100) + delta_gB_p_PP * (mean_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_min_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_min_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
}

  # store the mean of the lambdas 11-20
  mean_lambda_max_s=mean(l_max_s[10:19])
  mean_lambda_max_p=mean(l_max_p[10:19])

  mean_lambda_min_s=mean(l_min_s[10:19])
  mean_lambda_min_p=mean(l_min_p[10:19])

  # to store the 100 deltas, because we run the whole simulation(which is 500x) 100x again but with resampling some of the parameters
  s.delta.SAM[u]=abs((mean_lambda_max_s-mean_lambda_min_s)/((max_SAM-min_SAM)/sd_SAM))
  p.delta.SAM[u]=abs((mean_lambda_max_p-mean_lambda_min_p)/((max_SAM-min_SAM)/sd_SAM))
}  

hist(s.delta.SAM)
hist(p.delta.SAM)
p.delta.SAM
s.delta.SAM
```



### 4.2 With covariation
```{r}
# now each chunk is practically the same but with minor changes when it comes to perturbaion
# this one is number 4 therefore SAM is being perturbed (see outline to the right) but it's 4.2 in which we include the covariation among covariates whereas in 4.1 we assumed that there was no covariation
# this will go on with 5 for skua density, 6 for petrel density, 7 for SST, and finally 8 for Chla

# empty vector for lambdas
# to calculate lambdas for 20 years: l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
l_max_s=NULL 
l_max_p=NULL
l_min_s=NULL
l_min_p=NULL

# get mean lambdas
mean_lambda_max_p=NULL
mean_lambda_min_s=NULL
mean_lambda_min_p=NULL

# store sensitivities
p.deltaSAM.cov=NULL
s.deltaSAM.cov=NULL

N <- 20
for(u in 1:50){ # 50 resamples for uncertainties 
  for(t in 2:N) { 
  # MAX SAM
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM * max_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * max_SAM + delta_phiNB_p_SST[u] * SST_when_SAM_max + delta_phiNB_p_Chla[u] * dens_s_when_SAM_max + delta_phiNB_p_DD * (dens_p_when_SAM_max/100) + delta_phiNB_p_PP * (dens_s_when_SAM_max/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * max_SAM + delta_phiB_s_DD * (dens_s_when_SAM_max/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * max_SAM + delta_phiB_p_SST[u] * SST_when_SAM_max + delta_phiB_p_Chla[u] * dens_s_when_SAM_max + delta_phiB_p_DD * (dens_p_when_SAM_max/100) + delta_phiB_p_PP * (dens_s_when_SAM_max/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * max_SAM + delta_bNB_s_DD  * (dens_s_when_SAM_max/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * max_SAM + delta_gNB_s_DD * (dens_s_when_SAM_max/100) + delta_gNB_s_PP * (dens_p_when_SAM_max/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * max_SAM + delta_dNB_s_DD * (dens_s_when_SAM_max/100) + delta_dNB_s_PP * (dens_p_when_SAM_max/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * max_SAM + delta_bB_s_DD * (dens_s_when_SAM_max/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * max_SAM + delta_gB_s_DD * (dens_s_when_SAM_max/100) + delta_gB_s_PP * (dens_p_when_SAM_max/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * max_SAM + delta_dB_s_DD * (dens_s_when_SAM_max/100) + delta_dB_s_PP * (dens_p_when_SAM_max/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * max_SAM + delta_bNB_p_SST[u] * SST_when_SAM_max + delta_bNB_p_Chla[u] * Chla_when_SAM_max + delta_bNB_p_DD * (dens_p_when_SAM_max/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * max_SAM + delta_wNB_p_SST[u] * SST_when_SAM_max + delta_wNB_p_Chla[u]  * Chla_when_SAM_max + delta_wNB_p_DD * (dens_p_when_SAM_max/100) + delta_wNB_p_PP * (dens_s_when_SAM_max/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * max_SAM + delta_gNB_p_SST[u] * SST_when_SAM_max + delta_gNB_p_Chla[u] * Chla_when_SAM_max + delta_gNB_p_DD * (dens_p_when_SAM_max/100) + delta_gNB_p_PP * (dens_s_when_SAM_max/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * max_SAM + delta_bB_p_SST[u] * SST_when_SAM_max + delta_bB_p_Chla[u] * Chla_when_SAM_max + delta_bB_p_DD * (dens_p_when_SAM_max/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * max_SAM + delta_wB_p_SST[u] * SST_when_SAM_max + delta_wB_p_Chla[u] * Chla_when_SAM_max + delta_wB_p_DD * (dens_p_when_SAM_max/100) + delta_wB_p_PP * (dens_s_when_SAM_max/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * max_SAM + delta_gB_p_SST[u]  * SST_when_SAM_max + delta_gB_p_Chla[u] * Chla_when_SAM_max + delta_gB_p_DD  * (dens_p_when_SAM_max/100) + delta_gB_p_PP * (dens_s_when_SAM_max/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_max_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
  }
    
  for(t in 2:N) { # MIN SAM
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * min_SAM + delta_phiNB_s_DD * (dens_s_when_SAM_min/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * min_SAM + delta_phiNB_p_SST[u] * SST_when_SAM_min + delta_phiNB_p_Chla[u] * Chla_when_SAM_min + delta_phiNB_p_DD * (dens_p_when_SAM_min/100) + delta_phiNB_p_PP * (dens_s_when_SAM_min/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * min_SAM + delta_phiB_s_DD * (dens_s_when_SAM_min/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * min_SAM + delta_phiB_p_SST[u] * SST_when_SAM_min + delta_phiB_p_Chla[u] * Chla_when_SAM_min + delta_phiB_p_DD * (dens_p_when_SAM_min/100) + delta_phiB_p_PP * (dens_s_when_SAM_min/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * min_SAM + delta_bNB_s_DD  * (dens_s_when_SAM_min/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * min_SAM + delta_gNB_s_DD * (dens_s_when_SAM_min/100) + delta_gNB_s_PP * (dens_p_when_SAM_min/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * min_SAM + delta_dNB_s_DD * (dens_s_when_SAM_min/100) + delta_dNB_s_PP * (dens_p_when_SAM_min/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * min_SAM + delta_bB_s_DD * (dens_s_when_SAM_min/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * min_SAM + delta_gB_s_DD * (dens_s_when_SAM_min/100) + delta_gB_s_PP * (dens_p_when_SAM_min/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * min_SAM + delta_dB_s_DD * (dens_s_when_SAM_min/100) + delta_dB_s_PP * (dens_p_when_SAM_min/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * min_SAM + delta_bNB_p_SST[u] * SST_when_SAM_min + delta_bNB_p_Chla[u] * Chla_when_SAM_min + delta_bNB_p_DD * (dens_p_when_SAM_min/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * min_SAM + delta_wNB_p_SST[u] * SST_when_SAM_min + delta_wNB_p_Chla[u]  * Chla_when_SAM_min + delta_wNB_p_DD * (dens_p_when_SAM_min/100) + delta_wNB_p_PP * (dens_s_when_SAM_min/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * min_SAM + delta_gNB_p_SST[u] * SST_when_SAM_min + delta_gNB_p_Chla[u] * Chla_when_SAM_min + delta_gNB_p_DD * (dens_p_when_SAM_min/100) + delta_gNB_p_PP * (dens_s_when_SAM_min/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * min_SAM + delta_bB_p_SST[u] * SST_when_SAM_min + delta_bB_p_Chla[u] * Chla_when_SAM_min + delta_bB_p_DD * (dens_p_when_SAM_min/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * min_SAM + delta_wB_p_SST[u] * SST_when_SAM_min + delta_wB_p_Chla[u] * Chla_when_SAM_min + delta_wB_p_DD * (dens_p_when_SAM_min/100) + delta_wB_p_PP * (dens_s_when_SAM_min/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * min_SAM + delta_gB_p_SST[u]  * SST_when_SAM_min + delta_gB_p_Chla[u] * Chla_when_SAM_min + delta_gB_p_DD  * (dens_p_when_SAM_min/100) + delta_gB_p_PP * (dens_s_when_SAM_min/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_min_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_min_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
}

  # store the mean of the lambdas 101-500
  mean_lambda_max_s=mean(l_max_s[10:19])
  mean_lambda_max_p=mean(l_max_p[10:19])

  mean_lambda_min_s=mean(l_min_s[10:19])
  mean_lambda_min_p=mean(l_min_p[10:19])

  s.deltaSAM.cov[u]=abs((mean_lambda_max_s-mean_lambda_min_s)/((max_SAM-min_SAM)/sd_SAM))
  p.deltaSAM.cov[u]=abs((mean_lambda_max_p-mean_lambda_min_p)/((max_SAM-min_SAM)/sd_SAM))
}

s.deltaSAM.cov
p.deltaSAM.cov
```



## 5) Scaled sensitivities to skua density
### 5.1 Without covariation
```{r}
# same as above just but now perturbing skua density

# empty vector for lambdas
l_max_p=NULL
l_min_s=NULL
l_min_p=NULL

mean_lambda_max_s=NULL
mean_lambda_max_p=NULL
mean_lambda_min_s=NULL
mean_lambda_min_p=NULL


s.delta.DensS=NULL
p.delta.DensS=NULL

for(u in 1:50){
  # MAX
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (max_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * mean_SAM + delta_phiNB_p_SST[u] * mean_SST + delta_phiNB_p_Chla[u] * mean_Chla + delta_phiNB_p_DD * (mean_dens_p/100) + delta_phiNB_p_PP * (max_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (max_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * mean_SAM + delta_phiB_p_SST[u] * mean_SST + delta_phiB_p_Chla[u] * mean_Chla + delta_phiB_p_DD * (mean_dens_p/100) + delta_phiB_p_PP * (max_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (max_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (max_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (max_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (max_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (max_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (max_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * mean_SAM + delta_bNB_p_SST[u] * mean_SST + delta_bNB_p_Chla[u] * mean_Chla + delta_bNB_p_DD * (mean_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * mean_SAM + delta_wNB_p_SST[u] * mean_SST + delta_wNB_p_Chla[u]  * mean_Chla + delta_wNB_p_DD * (mean_dens_p/100) + delta_wNB_p_PP * (max_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * mean_SAM + delta_gNB_p_SST[u] * mean_SST + delta_gNB_p_Chla[u] * mean_Chla + delta_gNB_p_DD * (mean_dens_p/100) + delta_gNB_p_PP * (max_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * mean_SAM + delta_bB_p_SST[u] * mean_SST + delta_bB_p_Chla[u] * mean_Chla + delta_bB_p_DD * (mean_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * mean_SAM + delta_wB_p_SST[u] * mean_SST + delta_wB_p_Chla[u] * mean_Chla + delta_wB_p_DD * (mean_dens_p/100) + delta_wB_p_PP * (max_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * mean_SAM + delta_gB_p_SST[u]  * mean_SST + delta_gB_p_Chla[u] * mean_Chla + delta_gB_p_DD  * (mean_dens_p/100) + delta_gB_p_PP * (max_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_max_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
  }
    
  # MIN 
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (min_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * mean_SAM + delta_phiNB_p_SST[u] * mean_SST + delta_phiNB_p_Chla[u] * mean_Chla + delta_phiNB_p_DD * (mean_dens_p/100) + delta_phiNB_p_PP * (min_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (min_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * mean_SAM + delta_phiB_p_SST[u] * mean_SST + delta_phiB_p_Chla[u] * mean_Chla + delta_phiB_p_DD * (mean_dens_p/100) + delta_phiB_p_PP * (min_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (min_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (min_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (min_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (min_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (min_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (min_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * mean_SAM + delta_bNB_p_SST[u] * mean_SST + delta_bNB_p_Chla[u] * mean_Chla + delta_bNB_p_DD * (mean_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * mean_SAM + delta_wNB_p_SST[u] * mean_SST + delta_wNB_p_Chla[u]  * mean_Chla + delta_wNB_p_DD * (mean_dens_p/100) + delta_wNB_p_PP * (min_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * mean_SAM + delta_gNB_p_SST[u] * mean_SST + delta_gNB_p_Chla[u] * mean_Chla + delta_gNB_p_DD * (mean_dens_p/100) + delta_gNB_p_PP * (min_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * mean_SAM + delta_bB_p_SST[u] * mean_SST + delta_bB_p_Chla[u] * mean_Chla + delta_bB_p_DD * (mean_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * mean_SAM + delta_wB_p_SST[u] * mean_SST + delta_wB_p_Chla[u] * mean_Chla + delta_wB_p_DD * (mean_dens_p/100) + delta_wB_p_PP * (min_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * mean_SAM + delta_gB_p_SST[u]  * mean_SST + delta_gB_p_Chla[u] * mean_Chla + delta_gB_p_DD  * (mean_dens_p/100) + delta_gB_p_PP * (min_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_min_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_min_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
}


  mean_lambda_max_s=mean(l_max_s[10:19])
  mean_lambda_max_p=mean(l_max_p[10:19])

  mean_lambda_min_s=mean(l_min_s[10:19])
  mean_lambda_min_p=mean(l_min_p[10:19])


  s.delta.DensS[u]=abs((mean_lambda_max_s-mean_lambda_min_s)/((max_dens_s-min_dens_s)/sd_dens_s))
  p.delta.DensS[u]=abs((mean_lambda_max_p-mean_lambda_min_p)/((max_dens_s-min_dens_s)/sd_dens_s))
}
s.delta.DensS
p.delta.DensS
```

### 5.2 With covariation
```{r}

l_max_s=NULL 
l_max_p=NULL
l_min_s=NULL
l_min_p=NULL

lambda_max_s=NULL
lambda_max_p=NULL
lambda_min_s=NULL
lambda_min_p=NULL

s.deltaDensS.cov=NULL
p.deltaDensS.cov=NULL

for(u in 1:50){
  for(t in 2:N) { # MAX SAM
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * SAM_when_dens_s_max + delta_phiNB_s_DD * (max_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * SAM_when_dens_s_max + delta_phiNB_p_SST[u] * SST_when_dens_s_max + delta_phiNB_p_Chla[u] * Chla_when_dens_s_max + delta_phiNB_p_DD * (dens_p_when_dens_s_max/100) + delta_phiNB_p_PP * (max_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * SAM_when_dens_s_max + delta_phiB_s_DD * (max_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * SAM_when_dens_s_max + delta_phiB_p_SST[u] * SST_when_dens_s_max + delta_phiB_p_Chla[u] * Chla_when_dens_s_max + delta_phiB_p_DD * (dens_p_when_dens_s_max/100) + delta_phiB_p_PP * (max_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * SAM_when_dens_s_max + delta_bNB_s_DD  * (max_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * SAM_when_dens_s_max + delta_gNB_s_DD * (max_dens_s/100) + delta_gNB_s_PP * (dens_p_when_dens_s_max/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * SAM_when_dens_s_max + delta_dNB_s_DD * (max_dens_s/100) + delta_dNB_s_PP * (dens_p_when_dens_s_max/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * SAM_when_dens_s_max + delta_bB_s_DD * (max_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * SAM_when_dens_s_max + delta_gB_s_DD * (max_dens_s/100) + delta_gB_s_PP * (dens_p_when_dens_s_max/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * SAM_when_dens_s_max + delta_dB_s_DD * (max_dens_s/100) + delta_dB_s_PP * (dens_p_when_dens_s_max/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * SAM_when_dens_s_max + delta_bNB_p_SST[u] * SST_when_dens_s_max + delta_bNB_p_Chla[u] * Chla_when_dens_s_max + delta_bNB_p_DD * (dens_p_when_dens_s_max/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * SAM_when_dens_s_max + delta_wNB_p_SST[u] * SST_when_dens_s_max + delta_wNB_p_Chla[u]  * Chla_when_dens_s_max + delta_wNB_p_DD * (dens_p_when_dens_s_max/100) + delta_wNB_p_PP * (max_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * SAM_when_dens_s_max + delta_gNB_p_SST[u] * SST_when_dens_s_max + delta_gNB_p_Chla[u] * Chla_when_dens_s_max + delta_gNB_p_DD * (dens_p_when_dens_s_max/100) + delta_gNB_p_PP * (max_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * SAM_when_dens_s_max + delta_bB_p_SST[u] * SST_when_dens_s_max + delta_bB_p_Chla[u] * Chla_when_dens_s_max + delta_bB_p_DD * (dens_p_when_dens_s_max/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * SAM_when_dens_s_max + delta_wB_p_SST[u] * SST_when_dens_s_max + delta_wB_p_Chla[u] * Chla_when_dens_s_max + delta_wB_p_DD * (dens_p_when_dens_s_max/100) + delta_wB_p_PP * (max_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * SAM_when_dens_s_max + delta_gB_p_SST[u]  * SST_when_dens_s_max + delta_gB_p_Chla[u] * Chla_when_dens_s_max + delta_gB_p_DD  * (dens_p_when_dens_s_max/100) + delta_gB_p_PP * (max_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_max_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
  }
    
  for(t in 2:N) { # MIN SAM
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * SAM_when_dens_s_min + delta_phiNB_s_DD * (min_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * SAM_when_dens_s_min + delta_phiNB_p_SST[u] * SST_when_dens_s_min + delta_phiNB_p_Chla[u] * Chla_when_dens_s_min + delta_phiNB_p_DD * (dens_p_when_dens_s_min/100) + delta_phiNB_p_PP * (min_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * SAM_when_dens_s_min + delta_phiB_s_DD * (min_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * SAM_when_dens_s_min + delta_phiB_p_SST[u] * SST_when_dens_s_min + delta_phiB_p_Chla[u] * Chla_when_dens_s_min + delta_phiB_p_DD * (dens_p_when_dens_s_min/100) + delta_phiB_p_PP * (min_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * SAM_when_dens_s_min + delta_bNB_s_DD  * (min_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * SAM_when_dens_s_min + delta_gNB_s_DD * (min_dens_s/100) + delta_gNB_s_PP * (dens_p_when_dens_s_min/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * SAM_when_dens_s_min + delta_dNB_s_DD * (min_dens_s/100) + delta_dNB_s_PP * (dens_p_when_dens_s_min/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * SAM_when_dens_s_min + delta_bB_s_DD * (min_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * SAM_when_dens_s_min + delta_gB_s_DD * (min_dens_s/100) + delta_gB_s_PP * (dens_p_when_dens_s_min/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * SAM_when_dens_s_min + delta_dB_s_DD * (min_dens_s/100) + delta_dB_s_PP * (dens_p_when_dens_s_min/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * SAM_when_dens_s_min + delta_bNB_p_SST[u] * SST_when_dens_s_min + delta_bNB_p_Chla[u] * Chla_when_dens_s_min + delta_bNB_p_DD * (dens_p_when_dens_s_min/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * SAM_when_dens_s_min + delta_wNB_p_SST[u] * SST_when_dens_s_min + delta_wNB_p_Chla[u]  * Chla_when_dens_s_min + delta_wNB_p_DD * (dens_p_when_dens_s_min/100) + delta_wNB_p_PP * (min_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * SAM_when_dens_s_min + delta_gNB_p_SST[u] * SST_when_dens_s_min + delta_gNB_p_Chla[u] * Chla_when_dens_s_min + delta_gNB_p_DD * (dens_p_when_dens_s_min/100) + delta_gNB_p_PP * (min_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * SAM_when_dens_s_min + delta_bB_p_SST[u] * SST_when_dens_s_min + delta_bB_p_Chla[u] * Chla_when_dens_s_min + delta_bB_p_DD * (dens_p_when_dens_s_min/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * SAM_when_dens_s_min + delta_wB_p_SST[u] * SST_when_dens_s_min + delta_wB_p_Chla[u] * Chla_when_dens_s_min + delta_wB_p_DD * (dens_p_when_dens_s_min/100) + delta_wB_p_PP * (min_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * SAM_when_dens_s_min + delta_gB_p_SST[u]  * SST_when_dens_s_min + delta_gB_p_Chla[u] * Chla_when_dens_s_min + delta_gB_p_DD  * (dens_p_when_dens_s_min/100) + delta_gB_p_PP * (min_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_min_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_min_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
}

  mean_lambda_max_s=mean(l_max_s[10:19])
  mean_lambda_max_p=mean(l_max_p[10:19])

  mean_lambda_min_s=mean(l_min_s[10:19])
  mean_lambda_min_p=mean(l_min_p[10:19])

  s.deltaDensS.cov[u]=abs((mean_lambda_max_s-mean_lambda_min_s)/((max_dens_s-min_dens_s)/sd_dens_s))
  p.deltaDensS.cov[u]=abs((mean_lambda_max_p-mean_lambda_min_p)/((max_dens_s-min_dens_s)/sd_dens_s))
}
```




## 6) Scaled sensitivities to petrel density
### 6.1 Without covariation
```{r}

l_max_s=NULL 
l_max_p=NULL
l_min_s=NULL
l_min_p=NULL

mean_lambda_max_s=NULL
mean_lambda_max_p=NULL
mean_lambda_min_s=NULL
mean_lambda_min_p=NULL

s.delta.DensP=NULL
p.delta.DensP=NULL

for(u in 1:50){
  # MAX
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * mean_SAM + delta_phiNB_p_SST[u] * mean_SST + delta_phiNB_p_Chla[u] * mean_Chla + delta_phiNB_p_DD * (max_dens_p/100) + delta_phiNB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * mean_SAM + delta_phiB_p_SST[u] * mean_SST + delta_phiB_p_Chla[u] * mean_Chla + delta_phiB_p_DD * (max_dens_p/100) + delta_phiB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (max_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (max_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (max_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (max_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * mean_SAM + delta_bNB_p_SST[u] * mean_SST + delta_bNB_p_Chla[u] * mean_Chla + delta_bNB_p_DD * (max_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * mean_SAM + delta_wNB_p_SST[u] * mean_SST + delta_wNB_p_Chla[u]  * mean_Chla + delta_wNB_p_DD * (max_dens_p/100) + delta_wNB_p_PP * (mean_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * mean_SAM + delta_gNB_p_SST[u] * mean_SST + delta_gNB_p_Chla[u] * mean_Chla + delta_gNB_p_DD * (max_dens_p/100) + delta_gNB_p_PP * (mean_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * mean_SAM + delta_bB_p_SST[u] * mean_SST + delta_bB_p_Chla[u] * mean_Chla + delta_bB_p_DD * (max_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * mean_SAM + delta_wB_p_SST[u] * mean_SST + delta_wB_p_Chla[u] * mean_Chla + delta_wB_p_DD * (max_dens_p/100) + delta_wB_p_PP * (mean_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * mean_SAM + delta_gB_p_SST[u]  * mean_SST + delta_gB_p_Chla[u] * mean_Chla + delta_gB_p_DD  * (max_dens_p/100) + delta_gB_p_PP * (mean_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_max_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
  }
    
  # MIN 
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * mean_SAM + delta_phiNB_p_SST[u] * mean_SST + delta_phiNB_p_Chla[u] * mean_Chla + delta_phiNB_p_DD * (min_dens_p/100) + delta_phiNB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * mean_SAM + delta_phiB_p_SST[u] * mean_SST + delta_phiB_p_Chla[u] * mean_Chla + delta_phiB_p_DD * (min_dens_p/100) + delta_phiB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (min_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (min_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (min_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (min_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * mean_SAM + delta_bNB_p_SST[u] * mean_SST + delta_bNB_p_Chla[u] * mean_Chla + delta_bNB_p_DD * (min_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * mean_SAM + delta_wNB_p_SST[u] * mean_SST + delta_wNB_p_Chla[u]  * mean_Chla + delta_wNB_p_DD * (min_dens_p/100) + delta_wNB_p_PP * (mean_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * mean_SAM + delta_gNB_p_SST[u] * mean_SST + delta_gNB_p_Chla[u] * mean_Chla + delta_gNB_p_DD * (min_dens_p/100) + delta_gNB_p_PP * (mean_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * mean_SAM + delta_bB_p_SST[u] * mean_SST + delta_bB_p_Chla[u] * mean_Chla + delta_bB_p_DD * (min_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * mean_SAM + delta_wB_p_SST[u] * mean_SST + delta_wB_p_Chla[u] * mean_Chla + delta_wB_p_DD * (min_dens_p/100) + delta_wB_p_PP * (mean_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * mean_SAM + delta_gB_p_SST[u]  * mean_SST + delta_gB_p_Chla[u] * mean_Chla + delta_gB_p_DD  * (min_dens_p/100) + delta_gB_p_PP * (mean_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_min_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_min_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
}

  mean_lambda_max_s=mean(l_max_s[10:19])
  mean_lambda_max_p=mean(l_max_p[10:19])

  mean_lambda_min_s=mean(l_min_s[10:19])
  mean_lambda_min_p=mean(l_min_p[10:19])



  s.delta.DensP[u]=abs((mean_lambda_max_s-mean_lambda_min_s)/((max_dens_p-min_dens_p)/sd_dens_p))
  p.delta.DensP[u]=abs((mean_lambda_max_p-mean_lambda_min_p)/((max_dens_p-min_dens_p)/sd_dens_p))
}
```

### 6.2 With covariation
```{r}
l_max_s=NULL 
l_max_p=NULL
l_min_s=NULL
l_min_p=NULL

mean_lambda_max_s=NULL
mean_lambda_max_p=NULL
mean_lambda_min_s=NULL
mean_lambda_min_p=NULL

s.delta.DensP.cov=NULL
p.delta.DensP.cov=NULL

for(u in 1:50){
  # MAX
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * SAM_when_dens_p_max + delta_phiNB_s_DD * (dens_s_when_dens_p_max/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * SAM_when_dens_p_max + delta_phiNB_p_SST[u] * SST_when_dens_p_max + delta_phiNB_p_Chla[u] * Chla_when_dens_p_max + delta_phiNB_p_DD * (max_dens_p/100) + delta_phiNB_p_PP * (dens_s_when_dens_p_max/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * SAM_when_dens_p_max + delta_phiB_s_DD * (dens_s_when_dens_p_max/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * SAM_when_dens_p_max + delta_phiB_p_SST[u] * SST_when_dens_p_max + delta_phiB_p_Chla[u] * Chla_when_dens_p_max + delta_phiB_p_DD * (max_dens_p/100) + delta_phiB_p_PP * (dens_s_when_dens_p_max/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * SAM_when_dens_p_max + delta_bNB_s_DD  * (dens_s_when_dens_p_max/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * SAM_when_dens_p_max + delta_gNB_s_DD * (dens_s_when_dens_p_max/100) + delta_gNB_s_PP * (max_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * SAM_when_dens_p_max + delta_dNB_s_DD * (dens_s_when_dens_p_max/100) + delta_dNB_s_PP * (max_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * SAM_when_dens_p_max + delta_bB_s_DD * (dens_s_when_dens_p_max/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * SAM_when_dens_p_max + delta_gB_s_DD * (dens_s_when_dens_p_max/100) + delta_gB_s_PP * (max_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * SAM_when_dens_p_max + delta_dB_s_DD * (dens_s_when_dens_p_max/100) + delta_dB_s_PP * (max_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * SAM_when_dens_p_max + delta_bNB_p_SST[u] * SST_when_dens_p_max + delta_bNB_p_Chla[u] * Chla_when_dens_p_max + delta_bNB_p_DD * (max_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * SAM_when_dens_p_max + delta_wNB_p_SST[u] * SST_when_dens_p_max + delta_wNB_p_Chla[u]  * Chla_when_dens_p_max + delta_wNB_p_DD * (max_dens_p/100) + delta_wNB_p_PP * (dens_s_when_dens_p_max/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * SAM_when_dens_p_max + delta_gNB_p_SST[u] * SST_when_dens_p_max + delta_gNB_p_Chla[u] * Chla_when_dens_p_max + delta_gNB_p_DD * (max_dens_p/100) + delta_gNB_p_PP * (dens_s_when_dens_p_max/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * SAM_when_dens_p_max + delta_bB_p_SST[u] * SST_when_dens_p_max + delta_bB_p_Chla[u] * Chla_when_dens_p_max + delta_bB_p_DD * (max_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * SAM_when_dens_p_max + delta_wB_p_SST[u] * SST_when_dens_p_max + delta_wB_p_Chla[u] * Chla_when_dens_p_max + delta_wB_p_DD * (max_dens_p/100) + delta_wB_p_PP * (dens_s_when_dens_p_max/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * SAM_when_dens_p_max + delta_gB_p_SST[u]  * SST_when_dens_p_max + delta_gB_p_Chla[u] * Chla_when_dens_p_max + delta_gB_p_DD  * (max_dens_p/100) + delta_gB_p_PP * (dens_s_when_dens_p_max/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_max_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
  }
    
  # MIN 
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * SAM_when_dens_p_min + delta_phiNB_s_DD * (dens_s_when_dens_p_min/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * SAM_when_dens_p_min + delta_phiNB_p_SST[u] * SST_when_dens_p_min + delta_phiNB_p_Chla[u] * Chla_when_dens_p_min + delta_phiNB_p_DD * (min_dens_p/100) + delta_phiNB_p_PP * (dens_s_when_dens_p_min/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * SAM_when_dens_p_min + delta_phiB_s_DD * (dens_s_when_dens_p_min/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * SAM_when_dens_p_min + delta_phiB_p_SST[u] * SST_when_dens_p_min + delta_phiB_p_Chla[u] * Chla_when_dens_p_min + delta_phiB_p_DD * (min_dens_p/100) + delta_phiB_p_PP * (dens_s_when_dens_p_min/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * SAM_when_dens_p_min + delta_bNB_s_DD  * (dens_s_when_dens_p_min/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * SAM_when_dens_p_min + delta_gNB_s_DD * (dens_s_when_dens_p_min/100) + delta_gNB_s_PP * (min_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * SAM_when_dens_p_min + delta_dNB_s_DD * (dens_s_when_dens_p_min/100) + delta_dNB_s_PP * (min_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * SAM_when_dens_p_min + delta_bB_s_DD * (dens_s_when_dens_p_min/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * SAM_when_dens_p_min + delta_gB_s_DD * (dens_s_when_dens_p_min/100) + delta_gB_s_PP * (min_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * SAM_when_dens_p_min + delta_dB_s_DD * (dens_s_when_dens_p_min/100) + delta_dB_s_PP * (min_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * SAM_when_dens_p_min + delta_bNB_p_SST[u] * SST_when_dens_p_min + delta_bNB_p_Chla[u] * Chla_when_dens_p_min + delta_bNB_p_DD * (min_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * SAM_when_dens_p_min + delta_wNB_p_SST[u] * SST_when_dens_p_min + delta_wNB_p_Chla[u]  * Chla_when_dens_p_min + delta_wNB_p_DD * (min_dens_p/100) + delta_wNB_p_PP * (dens_s_when_dens_p_min/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * SAM_when_dens_p_min + delta_gNB_p_SST[u] * SST_when_dens_p_min + delta_gNB_p_Chla[u] * Chla_when_dens_p_min + delta_gNB_p_DD * (min_dens_p/100) + delta_gNB_p_PP * (dens_s_when_dens_p_min/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * SAM_when_dens_p_min + delta_bB_p_SST[u] * SST_when_dens_p_min + delta_bB_p_Chla[u] * Chla_when_dens_p_min + delta_bB_p_DD * (min_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * SAM_when_dens_p_min + delta_wB_p_SST[u] * SST_when_dens_p_min + delta_wB_p_Chla[u] * Chla_when_dens_p_min + delta_wB_p_DD * (min_dens_p/100) + delta_wB_p_PP * (dens_s_when_dens_p_min/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * SAM_when_dens_p_min + delta_gB_p_SST[u]  * SST_when_dens_p_min + delta_gB_p_Chla[u] * Chla_when_dens_p_min + delta_gB_p_DD  * (min_dens_p/100) + delta_gB_p_PP * (dens_s_when_dens_p_min/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_min_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_min_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
}

  mean_lambda_max_s=mean(l_max_s[10:19])
  mean_lambda_max_p=mean(l_max_p[10:19])

  mean_lambda_min_s=mean(l_min_s[10:19])
  mean_lambda_min_p=mean(l_min_p[10:19])



  s.delta.DensP.cov[u]=abs((mean_lambda_max_s-mean_lambda_min_s)/((max_dens_p-min_dens_p)/sd_dens_p))
  p.delta.DensP.cov[u]=abs((mean_lambda_max_p-mean_lambda_min_p)/((max_dens_p-min_dens_p)/sd_dens_p))
  }
```




## 7) Scaled sensitivities to SST (only petrel)
SST is only a covariate in the petrel vital rate functions. Therefore I will ignore skua completely.
### 7.1 Without covariation
```{r}

l_max_s=NULL 
l_max_p=NULL
l_min_s=NULL
l_min_p=NULL

mean_lambda_max_s=NULL
mean_lambda_max_p=NULL
mean_lambda_min_s=NULL
mean_lambda_min_p=NULL

p.delta.SST=NULL

for(u in 1:50){
  # MAX
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * mean_SAM + delta_phiNB_p_SST[u] * max_SST + delta_phiNB_p_Chla[u] * mean_Chla + delta_phiNB_p_DD * (mean_dens_p/100) + delta_phiNB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * mean_SAM + delta_phiB_p_SST[u] * max_SST + delta_phiB_p_Chla[u] * mean_Chla + delta_phiB_p_DD * (mean_dens_p/100) + delta_phiB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * mean_SAM + delta_bNB_p_SST[u] * max_SST + delta_bNB_p_Chla[u] * mean_Chla + delta_bNB_p_DD * (mean_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * mean_SAM + delta_wNB_p_SST[u] * max_SST + delta_wNB_p_Chla[u]  * mean_Chla + delta_wNB_p_DD * (mean_dens_p/100) + delta_wNB_p_PP * (mean_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * mean_SAM + delta_gNB_p_SST[u] * max_SST + delta_gNB_p_Chla[u] * mean_Chla + delta_gNB_p_DD * (mean_dens_p/100) + delta_gNB_p_PP * (mean_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * mean_SAM + delta_bB_p_SST[u] * max_SST + delta_bB_p_Chla[u] * mean_Chla + delta_bB_p_DD * (mean_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * mean_SAM + delta_wB_p_SST[u] * max_SST + delta_wB_p_Chla[u] * mean_Chla + delta_wB_p_DD * (mean_dens_p/100) + delta_wB_p_PP * (mean_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * mean_SAM + delta_gB_p_SST[u]  * max_SST + delta_gB_p_Chla[u] * mean_Chla + delta_gB_p_DD  * (mean_dens_p/100) + delta_gB_p_PP * (mean_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_max_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
  }
    
  # MIN 
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * mean_SAM + delta_phiNB_p_SST[u] * min_SST + delta_phiNB_p_Chla[u] * mean_Chla + delta_phiNB_p_DD * (mean_dens_p/100) + delta_phiNB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * mean_SAM + delta_phiB_p_SST[u] * min_SST + delta_phiB_p_Chla[u] * mean_Chla + delta_phiB_p_DD * (mean_dens_p/100) + delta_phiB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * mean_SAM + delta_bNB_p_SST[u] * min_SST + delta_bNB_p_Chla[u] * mean_Chla + delta_bNB_p_DD * (mean_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * mean_SAM + delta_wNB_p_SST[u] * min_SST + delta_wNB_p_Chla[u]  * mean_Chla + delta_wNB_p_DD * (mean_dens_p/100) + delta_wNB_p_PP * (mean_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * mean_SAM + delta_gNB_p_SST[u] * min_SST + delta_gNB_p_Chla[u] * mean_Chla + delta_gNB_p_DD * (mean_dens_p/100) + delta_gNB_p_PP * (mean_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * mean_SAM + delta_bB_p_SST[u] * min_SST + delta_bB_p_Chla[u] * mean_Chla + delta_bB_p_DD * (mean_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * mean_SAM + delta_wB_p_SST[u] * min_SST + delta_wB_p_Chla[u] * mean_Chla + delta_wB_p_DD * (mean_dens_p/100) + delta_wB_p_PP * (mean_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * mean_SAM + delta_gB_p_SST[u]  * min_SST + delta_gB_p_Chla[u] * mean_Chla + delta_gB_p_DD  * (mean_dens_p/100) + delta_gB_p_PP * (mean_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_min_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_min_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
}

  mean_lambda_max_s=mean(l_max_s[10:19])
  mean_lambda_max_p=mean(l_max_p[10:19])

  mean_lambda_min_s=mean(l_min_s[10:19])
  mean_lambda_min_p=mean(l_min_p[10:19])

  p.delta.SST[u]=abs((mean_lambda_max_p-mean_lambda_min_p)/((max_SST-min_SST)/sd_SST))
}
```

### 7.2 With covariation
```{r}
l_max_s=NULL 
l_max_p=NULL
l_min_s=NULL
l_min_p=NULL


mean_lambda_max_s=NULL
mean_lambda_max_p=NULL
mean_lambda_min_s=NULL
mean_lambda_min_p=NULL

p.delta.SST.cov=NULL
for(u in 1:50){
  # MAX
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * SAM_when_SST_max + delta_phiNB_p_SST[u] * max_SST + delta_phiNB_p_Chla[u] * Chla_when_SST_max + delta_phiNB_p_DD * (dens_p_when_SST_max/100) + delta_phiNB_p_PP * (dens_s_when_SST_max/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * SAM_when_SST_max + delta_phiB_p_SST[u] * max_SST + delta_phiB_p_Chla[u] * Chla_when_SST_max + delta_phiB_p_DD * (dens_p_when_SST_max/100) + delta_phiB_p_PP * (dens_s_when_SST_max/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * SAM_when_SST_max + delta_bNB_p_SST[u] * max_SST + delta_bNB_p_Chla[u] * Chla_when_SST_max + delta_bNB_p_DD * (dens_p_when_SST_max/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * SAM_when_SST_max + delta_wNB_p_SST[u] * max_SST + delta_wNB_p_Chla[u]  * Chla_when_SST_max + delta_wNB_p_DD * (dens_p_when_SST_max/100) + delta_wNB_p_PP * (dens_s_when_SST_max/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * SAM_when_SST_max + delta_gNB_p_SST[u] * max_SST + delta_gNB_p_Chla[u] * Chla_when_SST_max + delta_gNB_p_DD * (dens_p_when_SST_max/100) + delta_gNB_p_PP * (dens_s_when_SST_max/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * SAM_when_SST_max + delta_bB_p_SST[u] * max_SST + delta_bB_p_Chla[u] * Chla_when_SST_max + delta_bB_p_DD * (dens_p_when_SST_max/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * SAM_when_SST_max + delta_wB_p_SST[u] * max_SST + delta_wB_p_Chla[u] * Chla_when_SST_max + delta_wB_p_DD * (dens_p_when_SST_max/100) + delta_wB_p_PP * (dens_s_when_SST_max/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * SAM_when_SST_max + delta_gB_p_SST[u]  * max_SST + delta_gB_p_Chla[u] * Chla_when_SST_max + delta_gB_p_DD  * (dens_p_when_SST_max/100) + delta_gB_p_PP * (dens_s_when_SST_max/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_max_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
  }
    
  # MIN 
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * SAM_when_SST_min + delta_phiNB_p_SST[u] * min_SST + delta_phiNB_p_Chla[u] * Chla_when_SST_min + delta_phiNB_p_DD * (dens_p_when_SST_min/100) + delta_phiNB_p_PP * (dens_s_when_SST_min/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * SAM_when_SST_min + delta_phiB_p_SST[u] * min_SST + delta_phiB_p_Chla[u] * Chla_when_SST_min + delta_phiB_p_DD * (dens_p_when_SST_min/100) + delta_phiB_p_PP * (dens_s_when_SST_min/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * SAM_when_SST_min + delta_bNB_p_SST[u] * min_SST + delta_bNB_p_Chla[u] * Chla_when_SST_min + delta_bNB_p_DD * (dens_p_when_SST_min/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * SAM_when_SST_min + delta_wNB_p_SST[u] * min_SST + delta_wNB_p_Chla[u]  * Chla_when_SST_min + delta_wNB_p_DD * (dens_p_when_SST_min/100) + delta_wNB_p_PP * (dens_s_when_SST_min/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * SAM_when_SST_min + delta_gNB_p_SST[u] * min_SST + delta_gNB_p_Chla[u] * Chla_when_SST_min + delta_gNB_p_DD * (dens_p_when_SST_min/100) + delta_gNB_p_PP * (dens_s_when_SST_min/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * SAM_when_SST_min + delta_bB_p_SST[u] * min_SST + delta_bB_p_Chla[u] * Chla_when_SST_min + delta_bB_p_DD * (dens_p_when_SST_min/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * SAM_when_SST_min + delta_wB_p_SST[u] * min_SST + delta_wB_p_Chla[u] * Chla_when_SST_min + delta_wB_p_DD * (dens_p_when_SST_min/100) + delta_wB_p_PP * (dens_s_when_SST_min/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * SAM_when_SST_min + delta_gB_p_SST[u]  * min_SST + delta_gB_p_Chla[u] * Chla_when_SST_min + delta_gB_p_DD  * (dens_p_when_SST_min/100) + delta_gB_p_PP * (dens_s_when_SST_min/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_min_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_min_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
}

  mean_lambda_max_s=mean(l_max_s[10:19])
  mean_lambda_max_p=mean(l_max_p[10:19])

  mean_lambda_min_s=mean(l_min_s[10:19])
  mean_lambda_min_p=mean(l_min_p[10:19])

  
  p.delta.SST.cov[u]=abs((mean_lambda_max_p-mean_lambda_min_p)/((max_SST-min_SST)/sd_SST))
}
```



## 8) Scaled sensitivities to Chla (only petrel)
Chla is only a covariate in the petrel vital rate functions. Therefore I will ingore skua completely.

### 8.1 Without covariation
```{r}

l_max_s=NULL 
l_max_p=NULL
l_min_s=NULL
l_min_p=NULL

mean_lambda_max_s=NULL
mean_lambda_max_p=NULL
mean_lambda_min_s=NULL
mean_lambda_min_p=NULL

p.delta.Chla=NULL # only for petrel

for(u in 1:50){
  # MAX

  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * mean_SAM + delta_phiNB_p_SST[u] * mean_SST + delta_phiNB_p_Chla[u] * max_Chla + delta_phiNB_p_DD * (mean_dens_p/100) + delta_phiNB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * mean_SAM + delta_phiB_p_SST[u] * mean_SST + delta_phiB_p_Chla[u] * max_Chla + delta_phiB_p_DD * (mean_dens_p/100) + delta_phiB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * mean_SAM + delta_bNB_p_SST[u] * mean_SST + delta_bNB_p_Chla[u] * max_Chla + delta_bNB_p_DD * (mean_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * mean_SAM + delta_wNB_p_SST[u] * mean_SST + delta_wNB_p_Chla[u]  * max_Chla + delta_wNB_p_DD * (mean_dens_p/100) + delta_wNB_p_PP * (mean_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * mean_SAM + delta_gNB_p_SST[u] * mean_SST + delta_gNB_p_Chla[u] * max_Chla + delta_gNB_p_DD * (mean_dens_p/100) + delta_gNB_p_PP * (mean_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * mean_SAM + delta_bB_p_SST[u] * mean_SST + delta_bB_p_Chla[u] * max_Chla + delta_bB_p_DD * (mean_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * mean_SAM + delta_wB_p_SST[u] * mean_SST + delta_wB_p_Chla[u] * max_Chla + delta_wB_p_DD * (mean_dens_p/100) + delta_wB_p_PP * (mean_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * mean_SAM + delta_gB_p_SST[u]  * mean_SST + delta_gB_p_Chla[u] * max_Chla + delta_gB_p_DD  * (mean_dens_p/100) + delta_gB_p_PP * (mean_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_max_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
  }
    
  # MIN 
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * mean_SAM + delta_phiNB_p_SST[u] * mean_SST + delta_phiNB_p_Chla[u] * min_Chla + delta_phiNB_p_DD * (mean_dens_p/100) + delta_phiNB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * mean_SAM + delta_phiB_p_SST[u] * mean_SST + delta_phiB_p_Chla[u] * min_Chla + delta_phiB_p_DD * (mean_dens_p/100) + delta_phiB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * mean_SAM + delta_bNB_p_SST[u] * mean_SST + delta_bNB_p_Chla[u] * min_Chla + delta_bNB_p_DD * (mean_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * mean_SAM + delta_wNB_p_SST[u] * mean_SST + delta_wNB_p_Chla[u]  * min_Chla + delta_wNB_p_DD * (mean_dens_p/100) + delta_wNB_p_PP * (mean_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * mean_SAM + delta_gNB_p_SST[u] * mean_SST + delta_gNB_p_Chla[u] * min_Chla + delta_gNB_p_DD * (mean_dens_p/100) + delta_gNB_p_PP * (mean_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * mean_SAM + delta_bB_p_SST[u] * mean_SST + delta_bB_p_Chla[u] * min_Chla + delta_bB_p_DD * (mean_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * mean_SAM + delta_wB_p_SST[u] * mean_SST + delta_wB_p_Chla[u] * min_Chla + delta_wB_p_DD * (mean_dens_p/100) + delta_wB_p_PP * (mean_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * mean_SAM + delta_gB_p_SST[u]  * mean_SST + delta_gB_p_Chla[u] * min_Chla + delta_gB_p_DD  * (mean_dens_p/100) + delta_gB_p_PP * (mean_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_min_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_min_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
}

  mean_lambda_max_s=mean(l_max_s[10:19])
  mean_lambda_max_p=mean(l_max_p[10:19])

  mean_lambda_min_s=mean(l_min_s[10:19])
  mean_lambda_min_p=mean(l_min_p[10:19])


  p.delta.Chla[u]=abs((mean_lambda_max_p-mean_lambda_min_p)/((max_Chla-min_Chla)/sd_Chla))

}
```

### 8.2 With covariation
```{r}

l_max_s=NULL 
l_max_p=NULL
l_min_s=NULL
l_min_p=NULL


mean_lambda_max_s=NULL
mean_lambda_max_p=NULL
mean_lambda_min_s=NULL
mean_lambda_min_p=NULL

p.delta.Chla.cov=NULL

for(u in 1:50){
  # MAX
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * SAM_when_Chla_max + delta_phiNB_p_SST[u] * SST_when_Chla_max + delta_phiNB_p_Chla[u] * max_Chla + delta_phiNB_p_DD * (dens_p_when_Chla_max/100) + delta_phiNB_p_PP * (dens_s_when_Chla_max/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * SAM_when_Chla_max + delta_phiB_p_SST[u] * SST_when_Chla_max + delta_phiB_p_Chla[u] * max_Chla + delta_phiB_p_DD * (dens_p_when_Chla_max/100) + delta_phiB_p_PP * (dens_s_when_Chla_max/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * SAM_when_Chla_max + delta_bNB_p_SST[u] * SST_when_Chla_max + delta_bNB_p_Chla[u] * max_Chla + delta_bNB_p_DD * (dens_p_when_Chla_max/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * SAM_when_Chla_max + delta_wNB_p_SST[u] * SST_when_Chla_max + delta_wNB_p_Chla[u]  * max_Chla + delta_wNB_p_DD * (dens_p_when_Chla_max/100) + delta_wNB_p_PP * (dens_s_when_Chla_max/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * SAM_when_Chla_max + delta_gNB_p_SST[u] * SST_when_Chla_max + delta_gNB_p_Chla[u] * max_Chla + delta_gNB_p_DD * (dens_p_when_Chla_max/100) + delta_gNB_p_PP * (dens_s_when_Chla_max/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * SAM_when_Chla_max + delta_bB_p_SST[u] * SST_when_Chla_max + delta_bB_p_Chla[u] * max_Chla + delta_bB_p_DD * (dens_p_when_Chla_max/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * SAM_when_Chla_max + delta_wB_p_SST[u] * SST_when_Chla_max + delta_wB_p_Chla[u] * max_Chla + delta_wB_p_DD * (dens_p_when_Chla_max/100) + delta_wB_p_PP * (dens_s_when_Chla_max/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * SAM_when_Chla_max + delta_gB_p_SST[u]  * SST_when_Chla_max + delta_gB_p_Chla[u] * max_Chla + delta_gB_p_DD  * (dens_p_when_Chla_max/100) + delta_gB_p_PP * (dens_s_when_Chla_max/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_max_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
  }
    
  # MIN 
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * SAM_when_Chla_min + delta_phiNB_p_SST[u] * SST_when_Chla_min + delta_phiNB_p_Chla[u] * min_Chla + delta_phiNB_p_DD * (dens_p_when_Chla_min/100) + delta_phiNB_p_PP * (dens_s_when_Chla_min/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * SAM_when_Chla_min + delta_phiB_p_SST[u] * SST_when_Chla_min + delta_phiB_p_Chla[u] * min_Chla + delta_phiB_p_DD * (dens_p_when_Chla_min/100) + delta_phiB_p_PP * (dens_s_when_Chla_min/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * SAM_when_Chla_min + delta_bNB_p_SST[u] * SST_when_Chla_min + delta_bNB_p_Chla[u] * min_Chla + delta_bNB_p_DD * (dens_p_when_Chla_min/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * SAM_when_Chla_min + delta_wNB_p_SST[u] * SST_when_Chla_min + delta_wNB_p_Chla[u]  * min_Chla + delta_wNB_p_DD * (dens_p_when_Chla_min/100) + delta_wNB_p_PP * (dens_s_when_Chla_min/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * SAM_when_Chla_min + delta_gNB_p_SST[u] * SST_when_Chla_min + delta_gNB_p_Chla[u] * min_Chla + delta_gNB_p_DD * (dens_p_when_Chla_min/100) + delta_gNB_p_PP * (dens_s_when_Chla_min/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * SAM_when_Chla_min + delta_bB_p_SST[u] * SST_when_Chla_min + delta_bB_p_Chla[u] * min_Chla + delta_bB_p_DD * (dens_p_when_Chla_min/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * SAM_when_Chla_min + delta_wB_p_SST[u] * SST_when_Chla_min + delta_wB_p_Chla[u] * min_Chla + delta_wB_p_DD * (dens_p_when_Chla_min/100) + delta_wB_p_PP * (dens_s_when_Chla_min/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * SAM_when_Chla_min + delta_gB_p_SST[u]  * SST_when_Chla_min + delta_gB_p_Chla[u] * min_Chla + delta_gB_p_DD  * (dens_p_when_Chla_min/100) + delta_gB_p_PP * (dens_s_when_Chla_min/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_min_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_min_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
}

  mean_lambda_max_s=mean(l_max_s[10:19])
  mean_lambda_max_p=mean(l_max_p[10:19])

  mean_lambda_min_s=mean(l_min_s[10:19])
  mean_lambda_min_p=mean(l_min_p[10:19])

  p.delta.Chla.cov[u]=abs((mean_lambda_max_p-mean_lambda_min_p)/((max_Chla-min_Chla)/sd_Chla))
}
```


## 9) SAVE OUTPUT
```{r}
# sensitivities for skua
sens.skua=data.frame(s.delta.SAM=na.omit(s.delta.SAM)[1:10],
                     s.delta.DensS=na.omit(s.delta.DensS)[1:10],
                     s.delta.DensP=na.omit(s.delta.DensP)[1:10],
                     s.deltaSAM.cov=na.omit(s.deltaSAM.cov)[1:10],
                     s.deltaDensS.cov=na.omit(s.deltaDensS.cov)[1:10],
                     s.delta.DensP.cov=na.omit(s.delta.DensP.cov)[1:10])

# sensitivities for petrel
sens.petrel=data.frame(p.delta.SAM=na.omit(p.delta.SAM)[1:10],
                       p.delta.DensS=na.omit(p.delta.DensS)[1:10],
                       p.delta.DensP=na.omit(p.delta.DensP)[1:10],
                       p.delta.SST=na.omit(p.delta.SST)[1:10],
                       p.delta.Chla=na.omit(p.delta.Chla)[1:10],
                       p.deltaSAM.cov=na.omit(p.deltaSAM.cov)[1:10],
                       p.deltaDensS.cov=na.omit(p.deltaDensS.cov)[1:10],
                       p.delta.DensP.cov=na.omit(p.delta.DensP.cov)[1:10],
                       p.delta.SST.cov=na.omit(p.delta.SST.cov)[1:10],
                       p.delta.Chla.cov=na.omit(p.delta.Chla.cov)[1:10])

# reorganize sensitivities

# skua
s.df <- data.frame(study.doi="10.1002/ecm.1459",
                  year.of.publication="2021",
                  group="Birds",
                  species="Catharacta loennbergi",
                  continent="Sub-Antarctic",
                  driver=c(rep(c("SAM","IntraDens","InterDens"),each=10)),
                  driver.type=c(rep(c("C","D","B"),each=10)),
                  stage.age="all",
                  vital.rates="all",
                  sens.no.cov=c(sens.skua$s.delta.SAM,sens.skua$s.delta.DensS,sens.skua$s.delta.DensP),
                  sens.cov=c(sens.skua$s.deltaSAM.cov,sens.skua$s.deltaDensS.cov,sens.skua$s.delta.DensP.cov))

# petrel
p.df <-  data.frame(study.doi="10.1002/ecm.1459",
                  year.of.publication="2021",
                  group="Birds",
                  species="Halobaena caerulea",
                  continent="Sub-Antarctic",
                  driver = c(rep(c("SAM","InterDens","IntraDens","SST","Chla"),each=10)),
                  driver.type=c(rep(c("C","B","D","C","B"),each=10)),
                  stage.age="all",
                  vital.rates="all",
                  sens.no.cov=c(sens.petrel$p.delta.SAM,sens.petrel$p.delta.DensS,sens.petrel$p.delta.DensP,sens.petrel$p.delta.SST,sens.petrel$p.delta.Chla),
                  sens.cov=c(sens.petrel$p.deltaSAM.cov,sens.petrel$p.deltaDensS.cov,sens.petrel$p.delta.DensP.cov,sens.petrel$p.delta.SST.cov,sens.petrel$p.delta.Chla.cov))

# save
write.csv(s.df, "SensSkua_MCMC3.csv", row.names = F)
write.csv(p.df, "SensPetrel_MCMC3.csv",row.names = F)
```


# PLOT
```{r}
# old projections
df <- read.csv("~/Library/CloudStorage/OneDrive-UniversitätZürichUZH/Master Thesis/pert_analyses/ALL_SENS_WITH_RESAMPLING.csv", stringsAsFactors = T)
library(dplyr)
library(ggplot2)
df_skua <- filter(df, species == "Catharacta loennbergi")
df_skua$cov <- factor(df_skua$cov)
ggplot(df_skua, aes(x = driver.type, y = sens, fill = cov)) + geom_boxplot()

```





## SENS ANALYSIS TEMPLATE WITH MEAN VARIABLES
```{r}

# MODEL ----------------

# 500 sim
n.sim=500

# empty vector for lambdas
# to calculate lambdas for 10 years: l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
l_max_s=NULL 
l_max_p=NULL
l_min_s=NULL
l_min_p=NULL


# mean lambdas for each simulation (500): lambda_max_s[i] <- mean(l_max_s)
lambda_max_s=NULL
lambda_max_p=NULL
lambda_min_s=NULL
lambda_min_p=NULL

#get mean lambdas of the simulations 101-500: mean(na.omit(lambda_max_s[101:500]))
# without simulations (to get uncertainties), mean_lambda_max_s is going to be only 1 value
mean_lambda_max_s=NULL
mean_lambda_max_p=NULL
mean_lambda_min_s=NULL
mean_lambda_min_p=NULL

# to store delta (but only 1 because I'm not doing simulations to get uncertainties now)
#s.delta.DensS=NULL
#p.delta.DensS=NULL

# Number of years 
N <- 10


  # MAX
for(i in 1:n.sim){
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * mean_SAM + delta_phiNB_p_SST[u] * mean_SST + delta_phiNB_p_Chla[u] * mean_Chla + delta_phiNB_p_DD * (mean_dens_p/100) + delta_phiNB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * mean_SAM + delta_phiB_p_SST[u] * mean_SST + delta_phiB_p_Chla[u] * mean_Chla + delta_phiB_p_DD * (mean_dens_p/100) + delta_phiB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * mean_SAM + delta_bNB_p_SST[u] * mean_SST + delta_bNB_p_Chla[u] * mean_Chla + delta_bNB_p_DD * (mean_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * mean_SAM + delta_wNB_p_SST[u] * mean_SST + delta_wNB_p_Chla[u]  * mean_Chla + delta_wNB_p_DD * (mean_dens_p/100) + delta_wNB_p_PP * (mean_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * mean_SAM + delta_gNB_p_SST[u] * mean_SST + delta_gNB_p_Chla[u] * mean_Chla + delta_gNB_p_DD * (mean_dens_p/100) + delta_gNB_p_PP * (mean_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * mean_SAM + delta_bB_p_SST[u] * mean_SST + delta_bB_p_Chla[u] * mean_Chla + delta_bB_p_DD * (mean_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * mean_SAM + delta_wB_p_SST[u] * mean_SST + delta_wB_p_Chla[u] * mean_Chla + delta_wB_p_DD * (mean_dens_p/100) + delta_wB_p_PP * (mean_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * mean_SAM + delta_gB_p_SST[u]  * mean_SST + delta_gB_p_Chla[u] * mean_Chla + delta_gB_p_DD  * (mean_dens_p/100) + delta_gB_p_PP * (mean_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_max_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_max_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
  }
    
  # MIN 
  for(t in 2:N) { 
  
  ## Fecundity ---------------------
  
  ### Skua ----
  meanF1_s[t] <- (fecSB1_s / 2 * SB1_s[t-1]) + (fecSB2_s / 2 * SB2_s[t-1])  # fecSB1_s = 1 ; fecSB2_s = 2
  F1_s[t] <- rpois(1,meanF1_s[t])
  
  ### Petrel --------------
  meanF1_p[t] <- fecSB1_p / 2 * SB_p[t-1]
  F1_p[t] <- rpois(1,meanF1_p[t])
  
  
  ## Juvenile states ----------
  
  ### Apparent survival from F1 to J2 ------
  #### Skua -----
  J2_s[t] <- rbinom(1, F1_s[t-1], phi1_s)
  #### Petrel ------
  J2_p[t] <- rbinom(1, F1_p[t-1], phi1_p)
  
  ### Apparent survival from J2 to J3 -------
  #### Skua -----
  J3_s[t] <- rbinom(1, J2_s[t-1], phi2_s)
  #### Petrel -----
  J3_p[t] <- rbinom(1, J2_p[t-1], phi2_p) 
  
  ### Apparent survival from J3 to J4 -------
  #### Skua -----
  J4_J3_s[t] <- rbinom(1, J3_s[t-1], phi3_s)
  #### Petrel ------
  J4_J3_p[t] <- rbinom(1, J3_p[t-1], phi3_p)
  
  ### Apparent survival for immatures -----
  #### Skua -----
  J4_alive_s[t] <- rbinom(1, J4_NB_s[t-1], phi4_s)
  #### Petrel ------
  J4_alive_p[t] <- rbinom(1, J4_NB_p[t-1], phi4_p)
  
  ### Total of J4 : J3 + immmatures ------
  #### Skua -----
  J4_s[t]       <- J4_J3_s[t] + J4_alive_s[t]  
  #### Petrel ------
  J4_p[t]       <- J4_J3_p[t] + J4_alive_p[t]
  
  ## First breeding probability ------
  #### Skua -----
  PR_s[t] <- rnorm(1,meanPR_s,0.15)
  #### Petrel ------
  PR_p[t] <- rnorm(1,meanPR_p,0.15)
  
  ## Birds that become breeders ------
  #### Skua -----
  J4_B_s[t] <- rbinom(1, J4_s[t], PR_s[t])
  #### Petrel ------
  J4_B_p[t] <- rbinom(1, J4_p[t], PR_p[t])
  
  ## Birds that remain immatures -----
  #### Skua -----
  J4_NB_s[t] <- max(J4_s[t] - J4_B_s[t], 0)  
  #### Petrel ------
  J4_NB_p[t] <- max(J4_p[t] - J4_B_p[t], 0)
  
  ## Adult states -------

  ### Survival --------------------------
  
  #### Apparent survival for non breeders at year t-1 ----
  ##### Skua ------
  logit_phiNB_s[t-1] <- mu.phiNB_s + delta_phiNB_s_SAM[u] * mean_SAM + delta_phiNB_s_DD * (mean_dens_s/100)  
  phiNB_s[t-1] <- 1/(1+exp(-logit_phiNB_s[t-1])) 

  NB_alive_s[t] <- rbinom(1, NB_s[t-1], phiNB_s[t-1]) 
  
  ##### Petrel ------
  logit_phiNB_p[t-1] <- mu.phiNB_p  + delta_phiNB_p_SAM[u] * mean_SAM + delta_phiNB_p_SST[u] * mean_SST + delta_phiNB_p_Chla[u] * mean_Chla + delta_phiNB_p_DD * (mean_dens_p/100) + delta_phiNB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiNB_p[t-1] <- 1/(1+exp(-logit_phiNB_p[t-1]))
  
  NB_alive_p[t] <- rbinom(1, NB_p[t-1], phiNB_p[t-1])
  
  
  #### Apparent survival for breeders at year t-1 -----
  ##### Skua ------
  logit_phiB_s[t-1]  <- mu.phiB_s + delta_phiB_s_SAM[u] * mean_SAM + delta_phiB_s_DD * (mean_dens_s/100) 
  phiB_s[t-1] <- 1/(1+exp(-logit_phiB_s[t-1]))
  
  B_alive_s[t]  <- rbinom(1, B_s[t-1], phiB_s[t-1])            
  
  ##### Petrel ------
  logit_phiB_p[t-1] <- mu.phiB_p  + delta_phiB_p_Chla[u] * mean_SAM + delta_phiB_p_SST[u] * mean_SST + delta_phiB_p_Chla[u] * mean_Chla + delta_phiB_p_DD * (mean_dens_p/100) + delta_phiB_p_PP * (mean_dens_s/100)        # Survie Breeder
  phiB_p[t-1] <- 1/(1+exp(-logit_phiB_p[t-1]))
  
  B_alive_p[t]  <- rbinom(1, B_p[t-1], phiB_p[t-1])            
  
      
  #### Total number of adults : adults + immatures + immigrants -----
  N_alive_s[t] <- (NB_alive_s[t] + B_alive_s[t]  + J4_B_s[t] + nb_im_s[t])
  N_alive_p[t] <- (NB_alive_p[t] + B_alive_p[t]  + J4_B_p[t] + nb_im_p[t])
  
  
  ##  Breeding ------

  ### Skua -------
  
  # --------- Previous non breeders

  ### Breeding probability
  
  logit_bNB_s[t-1] <- mu.bNB_s + delta_bNB_s_SAM[u] * mean_SAM + delta_bNB_s_DD  * (mean_dens_s/100)
  bNB_s[t-1] <- 1/(1+exp(-logit_bNB_s[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_s[t]   <- rbinom(1, NB_alive_s[t], bNB_s[t-1])            
  # Number of previous non breeders that remain non breeders
  NB_NB_s[t]    <- max(NB_alive_s[t] - NB_B_i_s[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_s[t] <- (NB_B_i_s[t] + max(J4_B_s[t],2) + nb_im_s[t])    
  
  ### Successful breeding with at least one chick
  
  logit_gNB_s[t-1] <- mu.gNB_s + delta_gNB_s_SAM[u] * mean_SAM + delta_gNB_s_DD * (mean_dens_s/100) + delta_gNB_s_PP * (mean_dens_p/100)
  gNB_s[t-1] <- 1/(1+exp(-logit_gNB_s[t-1]))
  
  # Number of previous non breeders that succesfully breed with at least one chick
  NB_SB_s[t]   <- rbinom(1, NB_B_s[t] ,gNB_s[t-1])         
  # Number of previous non breeders that fail to breed
  NB_FB_s[t]   <- max(NB_B_s[t] - NB_SB_s[t], 0) 
  
  ### Successful breeding with two chicks
  
  logit_dNB_s[t-1] <- mu.dNB_s + delta_dNB_s_SAM[u] * mean_SAM + delta_dNB_s_DD * (mean_dens_s/100) + delta_dNB_s_PP * (mean_dens_p/100) # Probabilit? de r?ussir sa reproduction avec 2 poussins pour les Non Breeder
  dNB_s[t-1] <- 1/(1+exp(-logit_dNB_s[t-1]))
  
  # Number of previous non breeders that succesfully fledged two chicks
  NB_SB2_s[t]   <- rbinom(1, NB_SB_s[t],dNB_s[t-1])       
  # Number of previous non breeders that fail to succefully fledged two chicks
  NB_SB1_s[t]   <- max(NB_SB_s[t] - NB_SB2_s[t], 0)
  
  # ---------- Previous breeders
  
  ### Breeding probability
  
  logit_bB_s[t-1]  <- mu.bB_s + delta_bB_s_SAM[u] * mean_SAM + delta_bB_s_DD * (mean_dens_s/100)
  bB_s[t-1] <- 1/(1+exp(-logit_bB_s[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_s[t]     <- rbinom(1, B_alive_s[t], bB_s[t-1]) 
  # Number of previous breeders that will not try to breed at year t 
  B_NB_s[t]    <- max(B_alive_s[t] - B_B_s[t], 0) 
  
  ### Successful breeding with at least one chick
  
  logit_gB_s[t-1]  <- mu.gB_s + delta_gB_s_SAM[u] * mean_SAM + delta_gB_s_DD * (mean_dens_s/100) + delta_gB_s_PP * (mean_dens_p/100)
  gB_s[t-1] <- 1/(1+exp(-logit_gB_s[t-1]))
  
  # Number of previous breeders that successfully breed with at least one chick
  B_SB_s[t]   <- rbinom(1, B_B_s[t] ,gB_s[t-1])             
  # Number of previous breeders that fail to successfully fledged two chicks
  B_FB_s[t]  <- max(B_B_s[t] - B_SB_s[t], 0)
  
  ### Successful breeding with two chicks
  
  # Calcul du succ?s repro avec 2  (calculate reproduction success with 2 chicks)
  logit_dB_s[t-1]  <- mu.dB_s + delta_dB_s_SAM[u] * mean_SAM + delta_dB_s_DD * (mean_dens_s/100) + delta_dB_s_PP * (mean_dens_p/100)
  dB_s[t-1] <- 1/(1+exp(-logit_dB_s[t-1]))
  
  # Number of previous non breeders that successfully fledged two chicks
  B_SB2_s[t]   <- rbinom(1, B_SB_s[t], dB_s[t-1])        
  # Number of previous breeders that fail to successfully fledged two chicks
  B_SB1_s[t]   <- max(B_SB_s[t] - B_SB2_s[t], 0)
  
  #### Total number of individuals (Skua) -------

  # Total non breeders
  NB_s[t] <- B_NB_s[t] + NB_NB_s[t]
  # Total failed breeders
  FB_s[t] <- (NB_FB_s[t] + B_FB_s[t]) 
  # Total succesful breeders with one chick
  SB1_s[t] <- (NB_SB1_s[t] + B_SB1_s[t])					              
  # Total succesful breeders with two chicks
  SB2_s[t] <- (NB_SB2_s[t] + B_SB2_s[t])                        
  # Total breeders
  B_s[t] <- (FB_s[t] + SB1_s[t] + SB2_s[t]) 
  # Total adults
  Nadtot_s[t] <- NB_s[t] + FB_s[t] + SB1_s[t] + SB2_s[t]     
  
  ### Petrel ------
  
  # --------- Previous non breeders
  
  ### Breeding probability
  logit_bNB_p[t-1] <- mu.bNB_p + delta_bNB_p_SAM[u]  * mean_SAM + delta_bNB_p_SST[u] * mean_SST + delta_bNB_p_Chla[u] * mean_Chla + delta_bNB_p_DD * (mean_dens_p/100)
  bNB_p[t-1] <- 1/(1+exp(-logit_bNB_p[t-1]))
  
  # Number of previous non breeders that will try to breed at year t 
  NB_B_i_p[t]   <- rbinom(1, NB_alive_p[t] ,bNB_p[t-1])            
  # Number of previous non breeders that remain non breeder
  NB_NB_p[t]    <- max(NB_alive_p[t] - NB_B_i_p[t], 0)
  # Total of previous non breeders that will try to breed at year t (need to add juveniles and immigrants)
  NB_B_p[t] <- (NB_B_i_p[t] + J4_B_p[t] + nb_im_p[t])    
  
  ### Hatching success
  logit_wNB_p[t-1] <- mu.wNB_p + delta_wNB_p_SAM[u] * mean_SAM + delta_wNB_p_SST[u] * mean_SST + delta_wNB_p_Chla[u]  * mean_Chla + delta_wNB_p_DD * (mean_dens_p/100) + delta_wNB_p_PP * (mean_dens_s/100)
  wNB_p[t-1] <- 1/(1+exp(-logit_wNB_p[t-1]))
  
  # Number of previous non breeders that successfully hatched their egg
  NB_SH_p[t]   <- rbinom(1,max(NB_B_p[t],2),wNB_p[t-1])         
  # Number of previous non breeders that failed at the egg stage
  NB_FBE_p[t]   <- max(NB_B_p[t] - NB_SH_p[t],0) 
  
  ### Breeding success 
  logit_gNB_p[t-1] <- mu.gNB_p + delta_gNB_p_SAM[u] * mean_SAM + delta_gNB_p_SST[u] * mean_SST + delta_gNB_p_Chla[u] * mean_Chla + delta_gNB_p_DD * (mean_dens_p/100) + delta_gNB_p_PP * (mean_dens_s/100)
  gNB_p[t-1] <- 1/(1+exp(-logit_gNB_p[t-1]))
  
  # Number of previous non breeders that successfully breed
  NB_SB_p[t]   <- rbinom(1, NB_SH_p[t] ,gNB_p[t-1])       
  # Number of previous non breeders that failed at the chick stage
  NB_FBC_p[t]   <- max(NB_SH_p[t] - NB_SB_p[t], 0)
  
  # Breeders
  
  ### Breeding probability
  
  logit_bB_p[t-1]  <- mu.bB_p  + delta_bB_p_SAM[u]  * mean_SAM + delta_bB_p_SST[u] * mean_SST + delta_bB_p_Chla[u] * mean_Chla + delta_bB_p_DD * (mean_dens_p/100)
  bB_p[t-1] <- 1/(1+exp(-logit_bB_p[t-1]))
  
  # Number of previous breeders that will try to breed at year t 
  B_B_p[t]     <- rbinom(1, B_alive_p[t], bB_p[t-1]) 
  # Number of previous non breeders that remain non breeder
  B_NB_p[t]    <- max(B_alive_p[t] - B_B_p[t], 0)
  
  ### Hatching success
  
  logit_wB_p[t-1]  <- mu.wB_p  + delta_wB_p_SAM[u] * mean_SAM + delta_wB_p_SST[u] * mean_SST + delta_wB_p_Chla[u] * mean_Chla + delta_wB_p_DD * (mean_dens_p/100) + delta_wB_p_PP * (mean_dens_s/100)
  wB_p[t-1] <- 1/(1+exp(-logit_wB_p[t-1]))
  
  # Number of previous breeders that succefully hatched their egg
  B_SH_p[t]   <- rbinom(1, B_B_p[t] , wB_p[t-1])             
  # Number of previous breeders that failed at the egg stage
  B_FBE_p[t]  <- max(B_B_p[t] - B_SH_p[t], 0)
  
  ### Breeding success 
  
  logit_gB_p[t-1]  <- mu.gB_p  + delta_gB_p_SAM[u] * mean_SAM + delta_gB_p_SST[u]  * mean_SST + delta_gB_p_Chla[u] * mean_Chla + delta_gB_p_DD  * (mean_dens_p/100) + delta_gB_p_PP * (mean_dens_s/100)
  gB_p[t-1] <- 1/(1+exp(-logit_gB_p[t-1]))
  
  # Number of previous breeders that successfully breed
  B_SB_p[t]   <- rbinom(1, B_SH_p[t] , gB_p[t-1])       
  # Number of previous breeders that failed at the chick stage
  B_FBC_p[t]   <- max(B_SH_p[t] - B_SB_p[t], 0)
  
  
  #### Total number of individuals (Petrel) ---------
  
  # Total number of non breeders
  NB_p[t] <- NB_NB_p[t] + B_NB_p[t]
  # Total number of failed breeders at the egg stage
  FBE_p[t] <- (NB_FBE_p[t] + B_FBE_p[t]) 
  # Total number of failed breeders at the chick stage
  FBC_p[t] <- (NB_FBC_p[t] + B_FBC_p[t])					              
  # Total number of successful breeders
  SB_p[t] <- (NB_SB_p[t] + B_SB_p[t])                        
  # Total number of breeders
  B_p[t] <- (FBE_p[t] + FBC_p[t] + SB_p[t]) 
  # Total number of adults
  Nadtot_p[t] <- (NB_p[t] + FBE_p[t] + FBC_p[t] + SB_p[t])     
  
  l_min_s[t-1] <- Nadtot_s[t]/Nadtot_s[t-1]
  l_min_p[t-1] <- Nadtot_p[t]/Nadtot_p[t-1]
}
lambda_max_s[i] <- mean(l_max_s)
lambda_max_p[i] <- mean(l_max_p)
lambda_min_s[i] <- mean(l_min_s)
lambda_min_p[i] <- mean(l_min_p)
  
}

  # store the mean of the lambdas 101-500
  mean_lambda_max_s=mean(na.omit(lambda_max_s[101:500]))
  mean_lambda_max_p=mean(na.omit(lambda_max_p[101:500]))

  mean_lambda_min_s=mean(na.omit(lambda_min_s[101:500]))
  mean_lambda_min_p=mean(na.omit(lambda_min_p[101:500]))


  s.delta.DensP=abs((mean_lambda_max_s-mean_lambda_min_s)/((max_dens_p-min_dens_p)/sd_dens_p))
  p.delta.DensP=abs((mean_lambda_max_p-mean_lambda_min_p)/((max_dens_p-min_dens_p)/sd_dens_p))

  s.delta.DensP
  p.delta.DensP

```






